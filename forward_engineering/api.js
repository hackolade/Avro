"use strict";var Ii=Object.defineProperty;var a=(e,t)=>Ii(e,"name",{value:t,configurable:!0});var M=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var ee=M((uu,Ur)=>{"use strict";var Vr={},ji=a(e=>{Vr.lodash=e.require("lodash")},"setDependencies");Ur.exports={setDependencies:ji,dependencies:Vr}});var we=M((fu,Dr)=>{"use strict";var Mi={"avro.java.string":"metaValueString","java-element":"metaValueElement","java-element-class":"metaValueElementClass","java-class":"metaValueClass","java-key-class":"metaValueKeyClass"},Fi={"Confluent Schema Registry":"CONFLUENT_SCHEMA_REGISTRY","Azure Schema Registry":"AZURE_SCHEMA_REGISTRY","Pulsar Schema Registry":"PULSAR_SCHEMA_REGISTRY"},Li={CONFLUENT_SCHEMA_REGISTRY:"confluentSchemaRegistry",AZURE_SCHEMA_REGISTRY:"azureSchemaRegistry",PULSAR_SCHEMA_REGISTRY:"pulsarSchemaRegistry",SCHEMA_REGISTRY:"schemaRegistry",COMMON:"common"},qi=["type","doc","order","default","nullable"],Hi=["string","boolean","bytes","null","array","record","enum","fixed","int","long","float","double","map"];Dr.exports={META_VALUES_KEY_MAP:Mi,SCRIPT_TYPES:Li,SCHEMA_REGISTRIES_KEYS:Fi,GENERAL_ATTRIBUTES:qi,AVRO_TYPES:Hi}});var dt=M((lu,$r)=>{"use strict";var{dependencies:Vi}=ee(),{GENERAL_ATTRIBUTES:Ui}=we(),pt,zr=["avro.java.string","java-element","java-element-class","java-class","java-key-class"],Di=["record","fixed","enum"],zi={enum:["name","aliases","namespace","symbols","symbolDefault"],array:["items"],map:["values"],record:["name","aliases","namespace","fields"],fixed:["name","aliases","namespace","size","logicalType"],string:["logicalType"],bytes:["logicalType"],int:["logicalType"],long:["logicalType"]},$i=["precision","scale"],Gi={bytes:["decimal"],int:["date","time-millis"],long:["time-micros","timestamp-millis","timestamp-micros","local-timestamp-millis","local-timestamp-micros"],fixed:["decimal","duration"],string:["uuid"]},Yi=a(e=>Di.includes(e),"isNamedType"),Ji=a((e,t)=>{var r;return pt=Vi.lodash,pt.isArray(e)?e:((r=Gi[e.type])!=null&&r.includes(e.logicalType)||(e=pt.omit(e,"logicalType")),pt.pick(e,[...zi[t]||[],...Ui,...Wi(t,e.logicalType),...zr]))},"filterAttributes"),Wi=a((e,t)=>["bytes","fixed"].includes(e)&&t==="decimal"?$i:[],"getLogicalTypeAttributes"),Ki=a(e=>zr.includes(e),"isMetaProperty");$r.exports={isNamedType:Yi,filterAttributes:Ji,isMetaProperty:Ki}});var Ee=M((du,Wr)=>{"use strict";var{dependencies:qt}=ee(),{filterAttributes:Gr}=dt(),z,Lt=0,Yr="New_field",Zi=a(e=>{try{return JSON.parse(e)}catch{return{}}},"parseJson"),Qi=a(e=>(z=qt.lodash,z.flow([ht("type"),ht("doc"),ht("namespace"),ht("name")])(e)),"reorderAttributes"),ht=a(e=>t=>{let r=Object.keys(t);return r.includes(e)?[e,...r.filter(i=>i!==e)].reduce((i,o)=>({...z.omit(i,o),[o]:i[o]}),t):t},"setPropertyAsFirst"),Xi=a(e=>{z=qt.lodash;let t=z.uniqBy(e,r=>(r==null?void 0:r.type)||r);return t.length===1?z.first(t):t},"filterMultipleTypes"),Jr=a(e=>{let t=/[^A-Za-z0-9_]/g,r=/^[0-9]/;return(e||"").replace(t,"_").replace(r,"_")},"prepareName"),eo=a(e=>{let t=Object.keys(e).reduce((r,n)=>z.isUndefined(e[n])?r:{...r,[n]:e[n]},{});return Object.keys(t).length===1&&t.type?t.type:t},"simplifySchema"),to=a(()=>{let e=Lt?`${Yr}_${Lt++}`:Yr;return Lt++,e},"getDefaultName"),ro=a(e=>{z=qt.lodash;let t=["typeName","code","name","displayName"],r=t.find(n=>e[n]);return r?{...z.omit(e,t),name:Jr(e[r])}:e},"convertName"),no=a((e,t)=>{e=Gr(e,e.type),t=Gr(t,t.type);let r=["type","name","logicalType","precision","scale","size"];return z.isEqual(z.pick(e,r),z.pick(t,r))?e.fields||t.fields?z.isEqual(z.map(e.fields,"name"),z.map(t.fields,"name")):!0:!1},"compareSchemasByStructure");Wr.exports={parseJson:Zi,reorderAttributes:Qi,filterMultipleTypes:Xi,prepareName:Jr,simplifySchema:eo,getDefaultName:to,convertName:ro,compareSchemasByStructure:no}});var qe=M((yu,Xr)=>{"use strict";var io=require("crypto"),oo=require("util"),so=new Qr(4096);function Ke(e){return typeof Buffer.alloc=="function"?Buffer.alloc(e):new Buffer(e)}a(Ke,"newBuffer");function Kr(e,t){return typeof Buffer.from=="function"?Buffer.from(e,t):new Buffer(e,t)}a(Kr,"bufferFrom");function Zr(e){return e.charAt(0).toUpperCase()+e.slice(1)}a(Zr,"capitalize");function ao(e,t){return e===t?0:e<t?-1:1}a(ao,"compare");function uo(e,t,r){var n=e[t];return n===void 0?r:n}a(uo,"getOption");function co(e,t){t=t||"md5";var r=io.createHash(t);return r.end(e),r.read()}a(co,"getHash");function fo(e,t){var r=-1,n,i;if(!e)return-1;for(n=0,i=e.length;n<i;n++)if(e[n]===t){if(r>=0)return-2;r=n}return r}a(fo,"singleIndexOf");function lo(e,t){var r={},n,i;for(n=0;n<e.length;n++)i=e[n],r[t(i)]=i;return r}a(lo,"toMap");function po(e){return Object.keys(e).map(function(t){return e[t]})}a(po,"objectValues");function ho(e,t){var r={},n,i,o;for(n=0,i=e.length;n<i;n++){if(o=e[n],t&&(o=t(o)),r[o])return!0;r[o]=!0}return!1}a(ho,"hasDuplicates");function yo(e,t,r){var n=Object.getOwnPropertyNames(e),i,o,s;for(i=0,o=n.length;i<o;i++)if(s=n[i],!t.hasOwnProperty(s)||r){var u=Object.getOwnPropertyDescriptor(e,s);Object.defineProperty(t,s,u)}return t}a(yo,"copyOwnProperties");function _o(e,t){t=t|0;var r=e.charAt(t++);if(/[\d-]/.test(r)){for(;/[eE\d.+-]/.test(e.charAt(t));)t++;return t}else{if(/true|null/.test(e.slice(t-1,t+3)))return t+3;if(/false/.test(e.slice(t-1,t+4)))return t+4}var n=0,i=!1;do switch(r){case"{":case"[":i||n++;break;case"}":case"]":if(!i&&!--n)return t;break;case'"':if(i=!i,!n&&!i)return t;break;case"\\":t++}while(r=e.charAt(t++));return-1}a(_o,"jsonEnd");function mo(){throw new Error("abstract")}a(mo,"abstractFunction");function vo(e,t){var r=e.prototype,n,i,o,s;for(n=0,i=t.length;n<i;n++)o=t[n],s="get"+Zr(o),r[s]=oo.deprecate(u(o),"use `."+o+"` instead of `."+s+"()`");function u(c){return function(){var l=this[c];return typeof l=="function"?l.apply(this,arguments):l}}a(u,"createGetter")}a(vo,"addDeprecatedGetters");function Qr(e){this._len=e|0,this._pos=0,this._slab=Ke(this._len)}a(Qr,"BufferPool");Qr.prototype.alloc=function(e){var t=this._len;return e>t?Ke(e):(this._pos+e>t&&(this._slab=Ke(t),this._pos=0),this._slab.slice(this._pos,this._pos+=e))};function Pe(e){var t=1103515245,r=12345,n=Math.pow(2,31),i=Math.floor(e||Math.random()*(n-1));this._max=n,this._nextInt=function(){return i=(t*i+r)%n}}a(Pe,"Lcg");Pe.prototype.nextBoolean=function(){return!!(this._nextInt()%2)};Pe.prototype.nextInt=function(e,t){return t===void 0&&(t=e,e=0),t=t===void 0?this._max:t,e+Math.floor(this.nextFloat()*(t-e))};Pe.prototype.nextFloat=function(e,t){return t===void 0&&(t=e,e=0),t=t===void 0?1:t,e+(t-e)*this._nextInt()/this._max};Pe.prototype.nextString=function(e,t){e|=0,t=t||"aA";var r="";t.indexOf("a")>-1&&(r+="abcdefghijklmnopqrstuvwxyz"),t.indexOf("A")>-1&&(r+="ABCDEFGHIJKLMNOPQRSTUVWXYZ"),t.indexOf("#")>-1&&(r+="0123456789"),t.indexOf("!")>-1&&(r+="~`!@#$%^&*()_+-={}[]:\";'<>?,./|\\");for(var n=[],i=0;i<e;i++)n.push(this.choice(r));return n.join("")};Pe.prototype.nextBuffer=function(e){var t=[],r;for(r=0;r<e;r++)t.push(this.nextInt(256));return Kr(t)};Pe.prototype.choice=function(e){var t=e.length;if(!t)throw new Error("choosing from empty array");return e[this.nextInt(t)]};function Vt(){this._index=0,this._items=[]}a(Vt,"OrderedQueue");Vt.prototype.push=function(e){var t=this._items,r=t.length|0,n;for(t.push(e);r>0&&t[r].index<t[n=r-1>>1].index;)e=t[r],t[r]=t[n],t[n]=e,r=n};Vt.prototype.pop=function(){var e=this._items,t=e.length-1|0,r=e[0];if(!r||r.index>this._index)return null;if(this._index++,!t)return e.pop(),r;e[0]=e.pop();for(var n=t>>1,i=0,o,s,u,c,l,p,d;i<n&&(c=e[i],o=(i<<1)+1,s=i+1<<1,p=e[o],d=e[s],!d||p.index<=d.index?(l=p,u=o):(l=d,u=s),!(l.index>=c.index));)e[u]=c,e[i]=l,i=u;return r};function g(e,t){if(this.buf=e,this.pos=t|0,this.pos<0)throw new Error("negative offset")}a(g,"Tap");g.prototype.isValid=function(){return this.pos<=this.buf.length};g.prototype.readBoolean=function(){return!!this.buf[this.pos++]};g.prototype.skipBoolean=function(){this.pos++};g.prototype.writeBoolean=function(e){this.buf[this.pos++]=!!e};g.prototype.readInt=g.prototype.readLong=function(){var e=0,t=0,r=this.buf,n,i,o,s;do n=r[this.pos++],i=n&128,e|=(n&127)<<t,t+=7;while(i&&t<28);if(i){o=e,s=268435456;do n=r[this.pos++],o+=(n&127)*s,s*=128;while(n&128);return(o%2?-(o+1):o)/2}return e>>1^-(e&1)};g.prototype.skipInt=g.prototype.skipLong=function(){for(var e=this.buf;e[this.pos++]&128;);};g.prototype.writeInt=g.prototype.writeLong=function(e){var t=this.buf,r,n;if(e>=-1073741824&&e<1073741824){n=e>=0?e<<1:~e<<1|1;do t[this.pos]=n&127,n>>=7;while(n&&(t[this.pos++]|=128))}else{r=e>=0?e*2:-e*2-1;do t[this.pos]=r&127,r/=128;while(r>=1&&(t[this.pos++]|=128))}this.pos++};g.prototype.readFloat=function(){var e=this.buf,t=this.pos;if(this.pos+=4,!(this.pos>e.length))return this.buf.readFloatLE(t)};g.prototype.skipFloat=function(){this.pos+=4};g.prototype.writeFloat=function(e){var t=this.buf,r=this.pos;if(this.pos+=4,!(this.pos>t.length))return this.buf.writeFloatLE(e,r)};g.prototype.readDouble=function(){var e=this.buf,t=this.pos;if(this.pos+=8,!(this.pos>e.length))return this.buf.readDoubleLE(t)};g.prototype.skipDouble=function(){this.pos+=8};g.prototype.writeDouble=function(e){var t=this.buf,r=this.pos;if(this.pos+=8,!(this.pos>t.length))return this.buf.writeDoubleLE(e,r)};g.prototype.readFixed=function(e){var t=this.pos;if(this.pos+=e,!(this.pos>this.buf.length)){var r=so.alloc(e);return this.buf.copy(r,0,t,t+e),r}};g.prototype.skipFixed=function(e){this.pos+=e};g.prototype.writeFixed=function(e,t){t=t||e.length;var r=this.pos;this.pos+=t,!(this.pos>this.buf.length)&&e.copy(this.buf,r,0,t)};g.prototype.readBytes=function(){return this.readFixed(this.readLong())};g.prototype.skipBytes=function(){var e=this.readLong();this.pos+=e};g.prototype.writeBytes=function(e){var t=e.length;this.writeLong(t),this.writeFixed(e,t)};typeof Buffer.prototype.utf8Slice=="function"?g.prototype.readString=function(){var e=this.readLong(),t=this.pos,r=this.buf;if(this.pos+=e,!(this.pos>r.length))return this.buf.utf8Slice(t,t+e)}:g.prototype.readString=function(){var e=this.readLong(),t=this.pos,r=this.buf;if(this.pos+=e,!(this.pos>r.length))return this.buf.slice(t,t+e).toString()};g.prototype.skipString=function(){var e=this.readLong();this.pos+=e};g.prototype.writeString=function(e){var t=Buffer.byteLength(e),r=this.buf;this.writeLong(t);var n=this.pos;if(this.pos+=t,!(this.pos>r.length))if(t>64&&typeof Buffer.prototype.utf8Write=="function")r.utf8Write(e,n,t);else{var i,o,s,u;for(i=0,o=t;i<o;i++)s=e.charCodeAt(i),s<128?r[n++]=s:s<2048?(r[n++]=s>>6|192,r[n++]=s&63|128):(s&64512)===55296&&((u=e.charCodeAt(i+1))&64512)===56320?(s=65536+((s&1023)<<10)+(u&1023),i++,r[n++]=s>>18|240,r[n++]=s>>12&63|128,r[n++]=s>>6&63|128,r[n++]=s&63|128):(r[n++]=s>>12|224,r[n++]=s>>6&63|128,r[n++]=s&63|128)}};typeof Buffer.prototype.latin1Write=="function"?g.prototype.writeBinary=function(e,t){var r=this.pos;this.pos+=t,!(this.pos>this.buf.length)&&this.buf.latin1Write(e,r,t)}:typeof Buffer.prototype.binaryWrite=="function"?g.prototype.writeBinary=function(e,t){var r=this.pos;this.pos+=t,!(this.pos>this.buf.length)&&this.buf.binaryWrite(e,r,t)}:g.prototype.writeBinary=function(e,t){var r=this.pos;this.pos+=t,!(this.pos>this.buf.length)&&this.buf.write(e,r,t,"binary")};g.prototype.matchBoolean=function(e){return this.buf[this.pos++]-e.buf[e.pos++]};g.prototype.matchInt=g.prototype.matchLong=function(e){var t=this.readLong(),r=e.readLong();return t===r?0:t<r?-1:1};g.prototype.matchFloat=function(e){var t=this.readFloat(),r=e.readFloat();return t===r?0:t<r?-1:1};g.prototype.matchDouble=function(e){var t=this.readDouble(),r=e.readDouble();return t===r?0:t<r?-1:1};g.prototype.matchFixed=function(e,t){return this.readFixed(t).compare(e.readFixed(t))};g.prototype.matchBytes=g.prototype.matchString=function(e){var t=this.readLong(),r=this.pos;this.pos+=t;var n=e.readLong(),i=e.pos;e.pos+=n;var o=this.buf.slice(r,this.pos),s=e.buf.slice(i,e.pos);return o.compare(s)};g.prototype.unpackLongBytes=function(){var e=Ke(8),t=0,r=0,n=6,i=this.buf,o,s;for(o=i[this.pos++],s=o&1,e.fill(0),t|=(o&127)>>1;o&128;)o=i[this.pos++],t|=(o&127)<<n,n+=7,n>=8&&(n-=8,e[r++]=t,t>>=8);return e[r]=t,s&&Ht(e,8),e};g.prototype.packLongBytes=function(e){var t=(e[7]&128)>>7,r=this.buf,n=1,i=0,o=3,s;t?(Ht(e,8),s=1):s=0;for(var u=[e.readUIntLE(0,3),e.readUIntLE(3,3),e.readUIntLE(6,2)];o&&!u[--o];);for(;i<o;)for(s|=u[i++]<<n,n+=24;n>7;)r[this.pos++]=s&127|128,s>>=7,n-=7;s|=u[o]<<n;do r[this.pos]=s&127,s>>=7;while(s&&(r[this.pos++]|=128));this.pos++,t&&Ht(e,8)};function Ht(e,t){for(;t--;)e[t]=~e[t]}a(Ht,"invert");Xr.exports={abstractFunction:mo,addDeprecatedGetters:vo,bufferFrom:Kr,capitalize:Zr,copyOwnProperties:yo,getHash:co,compare:ao,getOption:uo,jsonEnd:_o,newBuffer:Ke,objectValues:po,toMap:lo,singleIndexOf:fo,hasDuplicates:ho,Lcg:Pe,OrderedQueue:Vt,Tap:g}});var gt=M((mu,an)=>{"use strict";var w=qe(),en=require("buffer"),P=require("util"),je=w.Tap,Ut=P.debuglog("avsc:types"),b=P.format,yt={array:K,boolean:Se,bytes:Q,double:de,enum:J,error:B,fixed:W,float:pe,int:ke,long:Z,map:$,null:te,record:B,string:se},go=/^[A-Za-z_][A-Za-z0-9_]*$/,H=new w.Lcg,Ie=new je(new en.SlowBuffer(1024)),Ae=null,He=[];function f(e,t){var r;if(Ae?(r=Ae,He.push([Ae,this]),Ae=null):r=this,this._hash=new bo,this.name=void 0,this.aliases=void 0,this.doc=e&&e.doc?""+e.doc:void 0,e){var n=e.name,i=e.namespace===void 0?t&&t.namespace:e.namespace;if(n!==void 0){n=_t(n,i),Ve(n)&&f.addError(new Error(b("cannot rename primitive type: %j",n)));var o=t&&t.registry;o&&(o[n]!==void 0&&f.addError(new Error(b("duplicate type name: %s",n))),o[n]=r)}else t&&t.noAnonymousTypes&&f.addError(new Error(b("missing name property in schema: %j",e)));this.name=n,this.aliases=e.aliases?e.aliases.map(function(s){return _t(s,i)}):[]}}a(f,"Type");f.forSchema=function(e,t){t=t||{},t.registry=t.registry||{};var r=function(c){switch(c===!0?c="always":c===!1?c="never":c===void 0?c="auto":typeof c=="string"&&(c=c.toLowerCase()),c){case"always":return re;case"never":return Y;case"auto":return;default:f.addError(new Error(b("invalid wrap unions option: %j",c)))}}(t.wrapUnions);if(e===null&&f.addError(new Error('invalid type: null (did you mean "null"?)')),f.isType(e))return e;var n;if(t.typeHook&&(n=t.typeHook(e,t)))return f.isType(n)||f.addError(new Error(b("invalid typehook return value: %j",n))),n;if(typeof e=="string")return e=_t(e,t.namespace),n=t.registry[e],n||(Ve(e)?t.registry[e]=f.forSchema({type:e},t):e);if(e.logicalType&&t.logicalTypes&&!Ae){var i=t.logicalTypes[e.logicalType];if(i){var o=t.namespace,s={};Object.keys(t.registry).forEach(function(c){s[c]=t.registry[c]});try{return Ut("instantiating logical type for %s",e.logicalType),new i(e,t)}catch(c){if(Ut("failed to instantiate logical type for %s",e.logicalType),t.assertLogicalTypes)throw c;Ae=null,t.namespace=o,t.registry=s}}}if(Array.isArray(e)){var u=e.map(function(c){return f.forSchema(c,t)});r||(r=wo(u)?re:Y),n=new r(u,t)}else n=function(c){var l=yt[c];if(l===void 0)throw new Error(b("unknown type: %j",c));return new l(e,t)}(e.type);return n};f.forValue=function(e,t){if(t=t||{},t.emptyArrayType=t.emptyArrayType||f.forSchema({type:"array",items:"null"}),t.valueHook){var r=t.valueHook(e,t);if(r!==void 0)return f.isType(r)||f.addError(new Error(b("invalid value hook return value: %j",r))),r}switch(typeof e){case"string":return f.forSchema("string",t);case"boolean":return f.forSchema("boolean",t);case"number":return(e|0)===e?f.forSchema("int",t):Math.abs(e)<9007199254740991?f.forSchema("float",t):f.forSchema("double",t);case"object":if(e===null)return f.forSchema("null",t);if(Array.isArray(e))return e.length?f.forSchema({type:"array",items:f.forTypes(e.map(function(i){return f.forValue(i,t)}),t)},t):t.emptyArrayType;if(Buffer.isBuffer(e))return f.forSchema("bytes",t);var n=Object.keys(e);return n.some(function(i){return!Ze(i)})?f.forSchema({type:"map",values:f.forTypes(n.map(function(i){return f.forValue(e[i],t)}),t)},t):f.forSchema({type:"record",fields:n.map(function(i){return{name:i,type:f.forValue(e[i],t)}})},t);default:f.addError(new Error(b("cannot infer type from: %j",e)))}};f.forTypes=function(e,t){if(e.length||f.addError(new Error("no types to combine")),e.length===1)return e[0];t=t||{};var r=[],n=0,i=!0;if(e.forEach(function(d){switch(d.typeName){case"union:unwrapped":i=!1,r=r.concat(d.types);break;case"union:wrapped":n++,r=r.concat(d.types);break;case"null":r.push(d);break;default:i=!1,r.push(d)}}),n){i||f.addError(new Error("cannot combine wrapped union"));var o={};r.forEach(function(d){var h=d.branchName,y=o[h];y?d.equals(y)||f.addError(new Error("inconsistent branch type")):o[h]=d});var s=t.wrapUnions,u;t.wrapUnions=!0;try{u=f.forSchema(Object.keys(o).map(function(d){return o[d]}),t)}catch(d){throw t.wrapUnions=s,d}return t.wrapUnions=s,u}var c={};r.forEach(function(d){var h=vt(d),y=c[h];y||(c[h]=y=[]),y.push(d)});var l=Object.keys(c),p=l.map(function(d){var h=c[d];if(h.length===1)return h[0];switch(d){case"null":case"boolean":return h[0];case"number":return Eo(h);case"string":return To(h,t);case"buffer":return So(h,t);case"array":return h=h.filter(function(y){return y!==t.emptyArrayType}),h.length?f.forSchema({type:"array",items:f.forTypes(h.map(function(y){return y.itemsType}),t)},t):t.emptyArrayType;default:return ko(h,t)}});return p.length===1?p[0]:f.forSchema(p,t)};f.isType=function(){var e=arguments.length;if(!e)return!1;var t=arguments[0];if(!t||typeof t._update!="function"||typeof t.fingerprint!="function")return!1;if(e===1)return!0;var r=t.typeName,n;for(n=1;n<e;n++)if(r.indexOf(arguments[n])===0)return!0;return!1};f.__reset=function(e){Ut("resetting type buffer to %d",e),Ie.buf=new en.SlowBuffer(e)};Object.defineProperty(f.prototype,"branchName",{enumerable:!0,get:function(){if(this.name)return this.name;var e=f.isType(this,"logical")?this.underlyingType:this;return f.isType(e,"abstract")?e._concreteTypeName:f.isType(e,"union")?void 0:e.typeName}});f.prototype.clone=function(e,t){return t?(t={coerce:!!t.coerceBuffers|0,fieldHook:t.fieldHook,qualifyNames:!!t.qualifyNames,skip:!!t.skipMissingFields,wrap:!!t.wrapUnions|0},this._copy(e,t)):this.fromBuffer(this.toBuffer(e))};f.prototype.compare=w.abstractFunction;f.prototype.compareBuffers=function(e,t){return this._match(new je(e),new je(t))};f.prototype.createResolver=function(e,t){if(f.isType(e)||f.addError(new Error(b("not a type: %j",e))),!f.isType(this,"union","logical")&&f.isType(e,"logical"))return this.createResolver(e.underlyingType,t);t=t||{},t.registry=t.registry||{};var r,n;if(f.isType(this,"record","error")&&f.isType(e,"record","error")&&(n=this.name+":"+e.name,r=t.registry[n],r))return r;if(r=new zt(this),n&&(t.registry[n]=r),f.isType(e,"union")){var i=e.types.map(function(o){return this.createResolver(o,t)},this);r._read=function(o){var s=o.readLong(),u=i[s];return u===void 0&&f.addError(new Error(b("invalid union index: %s",s))),i[s]._read(o)}}else this._update(r,e,t);return r._read||f.addError(new Error(b("cannot read %s as %s",e,this))),Object.freeze(r)};f.prototype.decode=function(e,t,r){var n=new je(e,t),i=tn(this,n,r);return n.isValid()?{value:i,offset:n.pos}:{value:void 0,offset:-1}};f.prototype.encode=function(e,t,r){var n=new je(t,r);return this._write(n,e),n.isValid()?n.pos:t.length-n.pos};f.prototype.equals=function(e){return f.isType(e)&&this.fingerprint().equals(e.fingerprint())};f.prototype.fingerprint=function(e){if(e)return w.getHash(JSON.stringify(this.schema()),e);if(!this._hash.str){var t=JSON.stringify(this.schema());this._hash.str=w.getHash(t).toString("binary")}return w.bufferFrom(this._hash.str,"binary")};f.prototype.fromBuffer=function(e,t,r){var n=new je(e),i=tn(this,n,t,r);return n.isValid()||f.addError(new Error("truncated buffer")),!r&&n.pos<e.length&&f.addError(new Error("trailing data")),i};f.prototype.fromString=function(e){return this._copy(JSON.parse(e),{coerce:2})};f.prototype.inspect=function(){var e=this.typeName,t=rn(e);if(Ve(e))return b("<%s>",t);var r=this.schema({exportAttrs:!0,noDeref:!0});return typeof r=="object"&&!f.isType(this,"logical")&&(r.type=void 0),b("<%s %j>",t,r)};f.prototype.isValid=function(e,t){var r=(t&&t.noUndeclaredFields)|0,n=t&&t.errorHook,i,o;return n&&(o=[],i=a(function(s,u){n.call(this,o.slice(),s,u,e)},"hook")),this._check(e,r,i,o)};f.prototype.random=w.abstractFunction;f.prototype.schema=function(e){return this._attrs({exportAttrs:!!(e&&e.exportAttrs),noDeref:!!(e&&e.noDeref)})};f.prototype.toBuffer=function(e){Ie.pos=0,this._write(Ie,e);var t=w.newBuffer(Ie.pos);return Ie.isValid()?Ie.buf.copy(t,0,0,Ie.pos):this._write(new je(t),e),t};f.prototype.toJSON=function(){return this.schema({exportAttrs:!0})};f.prototype.toString=function(e){return JSON.stringify(e===void 0?this.schema({noDeref:!0}):this._copy(e,{coerce:3}))};f.prototype.wrap=function(e){var t=this._branchConstructor;return t===null?null:new t(e)};f.prototype._attrs=function(e){e.derefed=e.derefed||{};var t=this.name;if(t!==void 0){if(e.noDeref||e.derefed[t])return t;e.derefed[t]=!0}var r={};this.name!==void 0&&(r.name=t),r.type=this.typeName;var n=this._deref(r,e);return n!==void 0&&(r=n),e.exportAttrs&&(this.aliases&&this.aliases.length&&(r.aliases=this.aliases),this.doc!==void 0&&(r.doc=this.doc)),r};f.prototype._createBranchConstructor=function(){var e=this.branchName;if(e==="null")return null;var t=~e.indexOf(".")?"this['"+e+"']":"this."+e,r="return function Branch$(val) { "+t+" = val; };",n=new Function(r)();return n.type=this,n.prototype.unwrap=new Function("return "+t+";"),n.prototype.unwrapped=n.prototype.unwrap,n};f.prototype._peek=function(e){var t=e.pos,r=this._read(e);return e.pos=t,r};f.prototype._check=w.abstractFunction;f.prototype._copy=w.abstractFunction;f.prototype._deref=w.abstractFunction;f.prototype._match=w.abstractFunction;f.prototype._read=w.abstractFunction;f.prototype._skip=w.abstractFunction;f.prototype._update=w.abstractFunction;f.prototype._write=w.abstractFunction;f.prototype.getAliases=function(){return this.aliases};f.prototype.getFingerprint=f.prototype.fingerprint;f.prototype.getName=function(e){return this.name||!e?this.name:this.branchName};f.prototype.getSchema=f.prototype.schema;f.prototype.getTypeName=function(){return this.typeName};function R(e){f.call(this),this._branchConstructor=this._createBranchConstructor(),e||Object.freeze(this)}a(R,"PrimitiveType");P.inherits(R,f);R.prototype._update=function(e,t){t.typeName===this.typeName&&(e._read=this._read)};R.prototype._copy=function(e){return this._check(e,void 0,N),e};R.prototype._deref=function(){return this.typeName};R.prototype.compare=w.compare;function te(){R.call(this)}a(te,"NullType");P.inherits(te,R);te.prototype._check=function(e,t,r){var n=e===null;return!n&&r&&r(e,this),n};te.prototype._read=function(){return null};te.prototype._skip=function(){};te.prototype._write=function(e,t){t!==null&&N(t,this)};te.prototype._match=function(){return 0};te.prototype.compare=te.prototype._match;te.prototype.typeName="null";te.prototype.random=te.prototype._read;function Se(){R.call(this)}a(Se,"BooleanType");P.inherits(Se,R);Se.prototype._check=function(e,t,r){var n=typeof e=="boolean";return!n&&r&&r(e,this),n};Se.prototype._read=function(e){return e.readBoolean()};Se.prototype._skip=function(e){e.skipBoolean()};Se.prototype._write=function(e,t){typeof t!="boolean"&&N(t,this),e.writeBoolean(t)};Se.prototype._match=function(e,t){return e.matchBoolean(t)};Se.prototype.typeName="boolean";Se.prototype.random=function(){return H.nextBoolean()};function ke(){R.call(this)}a(ke,"IntType");P.inherits(ke,R);ke.prototype._check=function(e,t,r){var n=e===(e|0);return!n&&r&&r(e,this),n};ke.prototype._read=function(e){return e.readInt()};ke.prototype._skip=function(e){e.skipInt()};ke.prototype._write=function(e,t){t!==(t|0)&&N(t,this),e.writeInt(t)};ke.prototype._match=function(e,t){return e.matchInt(t)};ke.prototype.typeName="int";ke.prototype.random=function(){return H.nextInt(1e3)|0};function Z(){R.call(this)}a(Z,"LongType");P.inherits(Z,R);Z.prototype._check=function(e,t,r){var n=typeof e=="number"&&e%1===0&&Gt(e);return!n&&r&&r(e,this),n};Z.prototype._read=function(e){var t=e.readLong();return Gt(t)||f.addError(new Error("potential precision loss")),t};Z.prototype._skip=function(e){e.skipLong()};Z.prototype._write=function(e,t){(typeof t!="number"||t%1||!Gt(t))&&N(t,this),e.writeLong(t)};Z.prototype._match=function(e,t){return e.matchLong(t)};Z.prototype._update=function(e,t){switch(t.typeName){case"int":e._read=t._read;break;case"abstract:long":case"long":e._read=this._read}};Z.prototype.typeName="long";Z.prototype.random=function(){return H.nextInt()};Z.__with=function(e,t){e=e||{};var r={toBuffer:"_toBuffer",fromBuffer:"_fromBuffer",fromJSON:"_fromJSON",toJSON:"_toJSON",isValid:"_isValid",compare:"compare"},n=new D(t);return Object.keys(r).forEach(function(i){e[i]===void 0&&f.addError(new Error(b("missing method implementation: %s",i))),n[r[i]]=e[i]}),Object.freeze(n)};function pe(){R.call(this)}a(pe,"FloatType");P.inherits(pe,R);pe.prototype._check=function(e,t,r){var n=typeof e=="number";return!n&&r&&r(e,this),n};pe.prototype._read=function(e){return e.readFloat()};pe.prototype._skip=function(e){e.skipFloat()};pe.prototype._write=function(e,t){typeof t!="number"&&N(t,this),e.writeFloat(t)};pe.prototype._match=function(e,t){return e.matchFloat(t)};pe.prototype._update=function(e,t){switch(t.typeName){case"float":case"int":e._read=t._read;break;case"abstract:long":case"long":e._read=function(r){return r.readLong()}}};pe.prototype.typeName="float";pe.prototype.random=function(){return H.nextFloat(1e3)};function de(){R.call(this)}a(de,"DoubleType");P.inherits(de,R);de.prototype._check=function(e,t,r){var n=typeof e=="number";return!n&&r&&r(e,this),n};de.prototype._read=function(e){return e.readDouble()};de.prototype._skip=function(e){e.skipDouble()};de.prototype._write=function(e,t){typeof t!="number"&&N(t,this),e.writeDouble(t)};de.prototype._match=function(e,t){return e.matchDouble(t)};de.prototype._update=function(e,t){switch(t.typeName){case"double":case"float":case"int":e._read=t._read;break;case"abstract:long":case"long":e._read=function(r){return r.readLong()}}};de.prototype.typeName="double";de.prototype.random=function(){return H.nextFloat()};function se(){R.call(this)}a(se,"StringType");P.inherits(se,R);se.prototype._check=function(e,t,r){var n=typeof e=="string";return!n&&r&&r(e,this),n};se.prototype._read=function(e){return e.readString()};se.prototype._skip=function(e){e.skipString()};se.prototype._write=function(e,t){typeof t!="string"&&N(t,this),e.writeString(t)};se.prototype._match=function(e,t){return e.matchString(t)};se.prototype._update=function(e,t){switch(t.typeName){case"bytes":case"string":e._read=this._read}};se.prototype.typeName="string";se.prototype.random=function(){return H.nextString(H.nextInt(32))};function Q(){R.call(this)}a(Q,"BytesType");P.inherits(Q,R);Q.prototype._check=function(e,t,r){var n=Buffer.isBuffer(e);return!n&&r&&r(e,this),n};Q.prototype._read=function(e){return e.readBytes()};Q.prototype._skip=function(e){e.skipBytes()};Q.prototype._write=function(e,t){Buffer.isBuffer(t)||N(t,this),e.writeBytes(t)};Q.prototype._match=function(e,t){return e.matchBytes(t)};Q.prototype._update=se.prototype._update;Q.prototype._copy=function(e,t){var r;switch((t&&t.coerce)|0){case 3:return this._check(e,void 0,N),e.toString("binary");case 2:return typeof e!="string"&&f.addError(new Error(b("cannot coerce to buffer: %j",e))),r=w.bufferFrom(e,"binary"),this._check(r,void 0,N),r;case 1:return nn(e)||f.addError(new Error(b("cannot coerce to buffer: %j",e))),r=w.bufferFrom(e.data),this._check(r,void 0,N),r;default:return this._check(e,void 0,N),w.bufferFrom(e)}};Q.prototype.compare=Buffer.compare;Q.prototype.typeName="bytes";Q.prototype.random=function(){return H.nextBuffer(H.nextInt(32))};function he(e,t){f.call(this),Array.isArray(e)||f.addError(new Error(b("non-array union schema: %j",e))),e.length||f.addError(new Error("empty union")),this.types=Object.freeze(e.map(function(r){return f.forSchema(r,t)})),this._branchIndices={},this.types.forEach(function(r,n){f.isType(r,"union")&&f.addError(new Error("unions cannot be directly nested"));var i=r.branchName;i&&this._branchIndices[i]!==void 0&&f.addError(new Error(b("duplicate union branch name: %j",i))),this._branchIndices[i]=n},this)}a(he,"UnionType");P.inherits(he,f);he.prototype._branchConstructor=function(){f.addError(new Error("unions cannot be directly wrapped"))};he.prototype._skip=function(e){this.types[e.readLong()]._skip(e)};he.prototype._match=function(e,t){var r=e.readLong(),n=t.readLong();return r===n?this.types[r]._match(e,t):r<n?-1:1};he.prototype._deref=function(e,t){return this.types.map(function(r){return r._attrs(t)})};he.prototype.getTypes=function(){return this.types};function Y(e,t){he.call(this,e,t),this._dynamicBranches=null,this._bucketIndices={},this.types.forEach(function(r,n){if(f.isType(r,"abstract","logical"))this._dynamicBranches||(this._dynamicBranches=[]),this._dynamicBranches.push({index:n,type:r});else{var i=vt(r);this._bucketIndices[i]!==void 0&&f.addError(new Error(b("ambiguous unwrapped union: %j",this))),this._bucketIndices[i]=n}},this),Object.freeze(this)}a(Y,"UnwrappedUnionType");P.inherits(Y,he);Y.prototype._getIndex=function(e){var t=this._bucketIndices[on(e)];return this._dynamicBranches&&(t=this._getBranchIndex(e,t)),t};Y.prototype._getBranchIndex=function(e,t){var r=this._dynamicBranches,n,i,o;for(n=0,i=r.length;n<i;n++)o=r[n],o.type._check(e)&&(t===void 0?t=o.index:f.addError(new Error("ambiguous conversion")));return t};Y.prototype._check=function(e,t,r,n){var i=this._getIndex(e),o=i!==void 0;return o?this.types[i]._check(e,t,r,n):(r&&r(e,this),o)};Y.prototype._read=function(e){var t=e.readLong(),r=this.types[t];if(r)return r._read(e);f.addError(new Error(b("invalid union index: %s",t)))};Y.prototype._write=function(e,t){var r=this._getIndex(t);r===void 0&&N(t,this),e.writeLong(r),t!==null&&this.types[r]._write(e,t)};Y.prototype._update=function(e,t,r){var n,i,o;for(n=0,i=this.types.length;n<i;n++){try{o=this.types[n].createResolver(t,r)}catch{continue}e._read=function(s){return o._read(s)};return}};Y.prototype._copy=function(e,t){var r=t&&t.coerce|0,n=t&&t.wrap|0,i;if(n===2)i=0;else{switch(r){case 1:nn(e)&&this._bucketIndices.buffer!==void 0?i=this._bucketIndices.buffer:i=this._getIndex(e);break;case 2:if(e===null)i=this._bucketIndices.null;else if(typeof e=="object"){var o=Object.keys(e);o.length===1&&(i=this._branchIndices[o[0]],e=e[o[0]])}break;default:i=this._getIndex(e)}if(i===void 0){N(e,this);return}}var s=this.types[i];if(e===null||n===3)return s._copy(e,t);switch(r){case 3:var u={};return u[s.branchName]=s._copy(e,t),u;default:return s._copy(e,t)}};Y.prototype.compare=function(e,t){var r=this._getIndex(e),n=this._getIndex(t);if(r===void 0)N(e,this);else if(n===void 0)N(t,this);else return r===n?this.types[r].compare(e,t):w.compare(r,n)};Y.prototype.typeName="union:unwrapped";Y.prototype.random=function(){var e=H.nextInt(this.types.length);return this.types[e].random()};function re(e,t){he.call(this,e,t),Object.freeze(this)}a(re,"WrappedUnionType");P.inherits(re,he);re.prototype._check=function(e,t,r,n){var i=!1;if(e===null)i=this._branchIndices.null!==void 0;else if(typeof e=="object"){var o=Object.keys(e);if(o.length===1){var s=o[0],u=this._branchIndices[s];if(u!==void 0)return r?(n.push(s),i=this.types[u]._check(e[s],t,r,n),n.pop(),i):this.types[u]._check(e[s],t)}}return!i&&r&&r(e,this),i};re.prototype._read=function(e){var t=this.types[e.readLong()];t||f.addError(new Error(b("invalid union index")));var r=t._branchConstructor;return r===null?null:new r(t._read(e))};re.prototype._write=function(e,t){var r,n,i;t===null?(r=this._branchIndices.null,r===void 0&&N(t,this),e.writeLong(r)):(n=Object.keys(t),n.length===1&&(i=n[0],r=this._branchIndices[i]),r===void 0&&N(t,this),e.writeLong(r),this.types[r]._write(e,t[i]))};re.prototype._update=function(e,t,r){var n,i,o,s;for(n=0,i=this.types.length;n<i;n++){try{o=this.types[n].createResolver(t,r)}catch{continue}s=this.types[n]._branchConstructor,s?e._read=function(u){return new s(o._read(u))}:e._read=function(){return null};return}};re.prototype._copy=function(e,t){var r=t&&t.wrap|0;if(r===2){var n=this.types[0];return e===null&&n.typeName==="null"?null:new n._branchConstructor(n._copy(e,t))}if(e===null&&this._branchIndices.null!==void 0)return null;var i,o,s;if(typeof e=="object"){var u=Object.keys(e);if(u.length===1){var c=u[0];if(i=this._branchIndices[c],i===void 0&&t.qualifyNames){var l,p;for(l=0,o=this.types.length;l<o;l++)if(p=this.types[l],p.name&&c===$t(p.name)){i=l;break}}i!==void 0&&(s=this.types[i]._copy(e[c],t))}}if(r===1&&s===void 0)for(i=0,o=this.types.length;i<o&&s===void 0;)try{s=this.types[i]._copy(e,t)}catch{i++}if(s!==void 0)return r===3?s:new this.types[i]._branchConstructor(s);N(e,this)};re.prototype.compare=function(e,t){var r=e===null?"null":Object.keys(e)[0],n=t===null?"null":Object.keys(t)[0],i=this._branchIndices[r];return r===n?r==="null"?0:this.types[i].compare(e[r],t[r]):w.compare(i,this._branchIndices[n])};re.prototype.typeName="union:wrapped";re.prototype.random=function(){var e=H.nextInt(this.types.length),t=this.types[e],r=t._branchConstructor;return r?new r(t.random()):null};function J(e,t){f.call(this,e,t),(!Array.isArray(e.symbols)||!e.symbols.length)&&f.addError(new Error(b("invalid enum symbols: %j",e.symbols))),this.symbols=Object.freeze(e.symbols.slice()),this._indices={},this.symbols.forEach(function(r,n){Ze(r)||f.addError(new Error(b("invalid %s symbol: %j",this,r))),this._indices[r]!==void 0&&f.addError(new Error(b("duplicate %s symbol: %j",this,r))),this._indices[r]=n},this),this._branchConstructor=this._createBranchConstructor(),Object.freeze(this)}a(J,"EnumType");P.inherits(J,f);J.prototype._check=function(e,t,r){var n=this._indices[e]!==void 0;return!n&&r&&r(e,this),n};J.prototype._read=function(e){var t=e.readLong(),r=this.symbols[t];return r===void 0&&f.addError(new Error(b("invalid %s enum index: %s",this.name,t))),r};J.prototype._skip=function(e){e.skipLong()};J.prototype._write=function(e,t){var r=this._indices[t];r===void 0&&N(t,this),e.writeLong(r)};J.prototype._match=function(e,t){return e.matchLong(t)};J.prototype.compare=function(e,t){return w.compare(this._indices[e],this._indices[t])};J.prototype._update=function(e,t){var r=this.symbols;t.typeName==="enum"&&(!t.name||~mt(this).indexOf(t.name))&&t.symbols.every(function(n){return~r.indexOf(n)})&&(e.symbols=t.symbols,e._read=t._read)};J.prototype._copy=function(e){return this._check(e,void 0,N),e};J.prototype._deref=function(e){e.symbols=this.symbols};J.prototype.getSymbols=function(){return this.symbols};J.prototype.typeName="enum";J.prototype.random=function(){return H.choice(this.symbols)};function W(e,t){f.call(this,e,t),(e.size!==(e.size|0)||e.size<1)&&f.addError(new Error(b("invalid %s size",this.branchName))),this.size=e.size|0,this._branchConstructor=this._createBranchConstructor(),Object.freeze(this)}a(W,"FixedType");P.inherits(W,f);W.prototype._check=function(e,t,r){var n=Buffer.isBuffer(e)&&e.length===this.size;return!n&&r&&r(e,this),n};W.prototype._read=function(e){return e.readFixed(this.size)};W.prototype._skip=function(e){e.skipFixed(this.size)};W.prototype._write=function(e,t){(!Buffer.isBuffer(t)||t.length!==this.size)&&N(t,this),e.writeFixed(t,this.size)};W.prototype._match=function(e,t){return e.matchFixed(t,this.size)};W.prototype.compare=Buffer.compare;W.prototype._update=function(e,t){t.typeName==="fixed"&&this.size===t.size&&(!t.name||~mt(this).indexOf(t.name))&&(e.size=this.size,e._read=this._read)};W.prototype._copy=Q.prototype._copy;W.prototype._deref=function(e){e.size=this.size};W.prototype.getSize=function(){return this.size};W.prototype.typeName="fixed";W.prototype.random=function(){return H.nextBuffer(this.size)};function $(e,t){f.call(this),e.values||f.addError(new Error(b("missing map values: %j",e))),this.valuesType=f.forSchema(e.values,t),this._branchConstructor=this._createBranchConstructor(),Object.freeze(this)}a($,"MapType");P.inherits($,f);$.prototype._check=function(e,t,r,n){if(!e||typeof e!="object"||Array.isArray(e))return r&&r(e,this),!1;var i=Object.keys(e),o=!0,s,u,c,l;if(r){for(c=n.length,n.push(""),s=0,u=i.length;s<u;s++)l=n[c]=i[s],this.valuesType._check(e[l],t,r,n)||(o=!1);n.pop()}else for(s=0,u=i.length;s<u;s++)if(!this.valuesType._check(e[i[s]],t))return!1;return o};$.prototype._read=function(e){for(var t=this.valuesType,r={},n;n=Dt(e);)for(;n--;){var i=e.readString();r[i]=t._read(e)}return r};$.prototype._skip=function(e){for(var t=this.valuesType,r,n;n=e.readLong();)if(n<0)r=e.readLong(),e.pos+=r;else for(;n--;)e.skipString(),t._skip(e)};$.prototype._write=function(e,t){(!t||typeof t!="object"||Array.isArray(t))&&N(t,this);var r=this.valuesType,n=Object.keys(t),i=n.length,o,s;if(i)for(e.writeLong(i),o=0;o<i;o++)s=n[o],e.writeString(s),r._write(e,t[s]);e.writeLong(0)};$.prototype._match=function(){f.addError(new Error("maps cannot be compared"))};$.prototype._update=function(e,t,r){t.typeName==="map"&&(e.valuesType=this.valuesType.createResolver(t.valuesType,r),e._read=this._read)};$.prototype._copy=function(e,t){if(e&&typeof e=="object"&&!Array.isArray(e)){var r=this.valuesType,n=Object.keys(e),i,o,s,u={};for(i=0,o=n.length;i<o;i++)s=n[i],u[s]=r._copy(e[s],t);return u}N(e,this)};$.prototype.compare=$.prototype._match;$.prototype.typeName="map";$.prototype.getValuesType=function(){return this.valuesType};$.prototype.random=function(){var e={},t,r;for(t=0,r=H.nextInt(10);t<r;t++)e[H.nextString(H.nextInt(20))]=this.valuesType.random();return e};$.prototype._deref=function(e,t){e.values=this.valuesType._attrs(t)};function K(e,t){f.call(this),e.items||f.addError(new Error(b("missing array items: %j",e))),this.itemsType=f.forSchema(e.items,t),this._branchConstructor=this._createBranchConstructor(),Object.freeze(this)}a(K,"ArrayType");P.inherits(K,f);K.prototype._check=function(e,t,r,n){if(!Array.isArray(e))return r&&r(e,this),!1;var i=!0,o,s,u;if(r){for(u=n.length,n.push(""),o=0,s=e.length;o<s;o++)n[u]=""+o,this.itemsType._check(e[o],t,r,n)||(i=!1);n.pop()}else for(o=0,s=e.length;o<s;o++)if(!this.itemsType._check(e[o],t))return!1;return i};K.prototype._read=function(e){for(var t=this.itemsType,r=[],n;n=e.readLong();)for(n<0&&(n=-n,e.skipLong());n--;)r.push(t._read(e));return r};K.prototype._skip=function(e){for(var t,r;r=e.readLong();)if(r<0)t=e.readLong(),e.pos+=t;else for(;r--;)this.itemsType._skip(e)};K.prototype._write=function(e,t){Array.isArray(t)||N(t,this);var r=t.length,n;if(r)for(e.writeLong(r),n=0;n<r;n++)this.itemsType._write(e,t[n]);e.writeLong(0)};K.prototype._match=function(e,t){for(var r=e.readLong(),n=t.readLong(),i;r&&n;){if(i=this.itemsType._match(e,t),i)return i;--r||(r=Dt(e)),--n||(n=Dt(t))}return w.compare(r,n)};K.prototype._update=function(e,t,r){t.typeName==="array"&&(e.itemsType=this.itemsType.createResolver(t.itemsType,r),e._read=this._read)};K.prototype._copy=function(e,t){Array.isArray(e)||N(e,this);var r=new Array(e.length),n,i;for(n=0,i=e.length;n<i;n++)r[n]=this.itemsType._copy(e[n],t);return r};K.prototype._deref=function(e,t){e.items=this.itemsType._attrs(t)};K.prototype.compare=function(e,t){var r=e.length,n=t.length,i,o,s;for(i=0,o=Math.min(r,n);i<o;i++)if(s=this.itemsType.compare(e[i],t[i]))return s;return w.compare(r,n)};K.prototype.getItemsType=function(){return this.itemsType};K.prototype.typeName="array";K.prototype.random=function(){var e=[],t,r;for(t=0,r=H.nextInt(10);t<r;t++)e.push(this.itemsType.random());return e};function B(e,t){t=t||{};var r=t.namespace;if(e.namespace!==void 0)t.namespace=e.namespace;else if(e.name){var n=/^(.*)\.[^.]+$/.exec(e.name);n&&(t.namespace=n[1])}f.call(this,e,t),Array.isArray(e.fields)||f.addError(new Error(b("non-array record fields: %j",e.fields??"no `fields` in schema"))),w.hasDuplicates(e.fields,function(i){return i.name})&&f.addError(new Error(b("duplicate field name: %j",e.fields))),this._fieldsByName={},this.fields=Object.freeze(e.fields.map(function(i){var o=new Te(i,t);return this._fieldsByName[o.name]=o,o},this)),this._branchConstructor=this._createBranchConstructor(),this._isError=e.type==="error",this.recordConstructor=this._createConstructor(t.errorStackTraces),this._read=this._createReader(),this._skip=this._createSkipper(),this._write=this._createWriter(),this._check=this._createChecker(),t.namespace=r,Object.freeze(this)}a(B,"RecordType");P.inherits(B,f);B.prototype._getConstructorName=function(){return this.name?$t(this.name):this._isError?"Error$":"Record$"};B.prototype._createConstructor=function(e){var t=[],r=[],n=[],i="",o,s,u,c,l,p,d;for(o=0,s=this.fields.length;o<s;o++)u=this.fields[o],l=u.defaultValue,p=l()!==void 0,c=u.name,e&&this._isError&&c==="stack"&&f.isType(u.type,"string")&&!p&&(d=u),r.push("v"+o),i+="  ",p?(i+="if (v"+o+" === undefined) { ",i+="this."+c+" = d"+n.length+"(); ",i+="} else { this."+c+" = v"+o+`; }
`,t.push("d"+n.length),n.push(l)):i+="this."+c+" = v"+o+`;
`;d&&(i+="  if (this.stack === undefined) { ",typeof Error.captureStackTrace=="function"?i+="Error.captureStackTrace(this, this.constructor);":i+="this.stack = Error().stack;",i+=` }
`);var h="return function "+this._getConstructorName()+"(";h+=r.join()+`) {
`+i+"};";var y=new Function(t.join(),h).apply(void 0,n),_=this;return y.getType=function(){return _},y.type=_,this._isError&&(P.inherits(y,Error),y.prototype.name=this._getConstructorName()),y.prototype.clone=function(m){return _.clone(this,m)},y.prototype.compare=function(m){return _.compare(this,m)},y.prototype.isValid=function(m){return _.isValid(this,m)},y.prototype.toBuffer=function(){return _.toBuffer(this)},y.prototype.toString=function(){return _.toString(this)},y.prototype.wrap=function(){return _.wrap(this)},y.prototype.wrapped=y.prototype.wrap,y};B.prototype._createChecker=function(){var e=[],t=[],r=this._getConstructorName(),n="return function check"+r+`(v, f, h, p) {
`;if(n+=`  if (
`,n+=`    v === null ||
`,n+=`    typeof v != 'object' ||
`,n+=`    (f && !this._checkFields(v))
`,n+=`  ) {
`,n+=`    if (h) { h(v, this); }
`,n+=`    return false;
`,n+=`  }
`,!this.fields.length)n+=`  return true;
`;else{for(i=0,o=this.fields.length;i<o;i++)s=this.fields[i],e.push("t"+i),t.push(s.type),s.defaultValue()!==void 0&&(n+="  var v"+i+" = v."+s.name+`;
`);n+=`  if (h) {
`,n+=`    var b = 1;
`,n+=`    var j = p.length;
`,n+=`    p.push('');
`;var i,o,s;for(i=0,o=this.fields.length;i<o;i++)s=this.fields[i],n+="    p[j] = '"+s.name+`';
`,n+="    b &= ",s.defaultValue()===void 0?n+="t"+i+"._check(v."+s.name+`, f, h, p);
`:(n+="v"+i+" === undefined || ",n+="t"+i+"._check(v"+i+`, f, h, p);
`);n+=`    p.pop();
`,n+=`    return !!b;
`,n+=`  } else {
    return (
      `,n+=this.fields.map(function(u,c){return u.defaultValue()===void 0?"t"+c+"._check(v."+u.name+", f)":"(v"+c+" === undefined || t"+c+"._check(v"+c+", f))"}).join(` &&
      `),n+=`
    );
  }
`}return n+="};",new Function(e.join(),n).apply(void 0,t)};B.prototype._createReader=function(){var e=[],t=[this.recordConstructor],r,n;for(r=0,n=this.fields.length;r<n;r++)e.push("t"+r),t.push(this.fields[r].type);var i=this._getConstructorName(),o="return function read"+i+`(t) {
`;return o+="  return new "+i+`(
    `,o+=e.map(function(s){return s+"._read(t)"}).join(`,
    `),o+=`
  );
};`,e.unshift(i),new Function(e.join(),o).apply(void 0,t)};B.prototype._createSkipper=function(){var e=[],t="return function skip"+this._getConstructorName()+`(t) {
`,r=[],n,i;for(n=0,i=this.fields.length;n<i;n++)e.push("t"+n),r.push(this.fields[n].type),t+="  t"+n+`._skip(t);
`;return t+="}",new Function(e.join(),t).apply(void 0,r)};B.prototype._createWriter=function(){var e=[],t=this._getConstructorName(),r="return function write"+t+`(t, v) {
`,n=[],i,o,s,u;for(i=0,o=this.fields.length;i<o;i++)s=this.fields[i],e.push("t"+i),n.push(s.type),r+="  ",s.defaultValue()===void 0?r+="t"+i+"._write(t, v."+s.name+`);
`:(u=s.type.toBuffer(s.defaultValue()).toString("binary"),e.push("d"+i),n.push(u),r+="var v"+i+" = v."+s.name+`;
`,r+="if (v"+i+` === undefined) {
`,r+="    t.writeBinary(d"+i+", "+u.length+`);
`,r+=`  } else {
    t`+i+"._write(t, v"+i+`);
  }
`);return r+="}",new Function(e.join(),r).apply(void 0,n)};B.prototype._update=function(e,t,r){t.name&&!~mt(this).indexOf(t.name)&&f.addError(new Error(b("no alias found for %s",t.name)));var n=this.fields,i=t.fields,o=w.toMap(i,function(oe){return oe.name}),s=[],u={},c,l,p,d,h,y,_;for(c=0;c<n.length;c++){for(p=n[c],h=mt(p),y=[],l=0;l<h.length;l++)d=h[l],o[d]&&y.push(d);y.length>1&&f.addError(new Error)(b("ambiguous aliasing for %s.%s (%s)",t.name,p.name,y)),y.length?(d=y[0],_={resolver:p.type.createResolver(o[d].type,r),name:"_"+p.name},u[d]?u[d].push(_):u[d]=[_],s.push(_.name)):(p.defaultValue()===void 0&&f.addError(new Error)(b("no matching field for default-less %s.%s",t.name,p.name)),s.push("undefined"))}var m=-1;for(c=i.length;c&&u[i[--c].name]===void 0;)m=c;var v=this._getConstructorName(),k=[v],C=[this.recordConstructor],T="  return function read"+v+`(t, b) {
`;for(c=0;c<i.length;c++)if(c===m&&(T+=`  if (!b) {
`),p=t.fields[c],d=p.name,u[d]===void 0)T+=~m&&c>=m?"    ":"  ",k.push("r"+c),C.push(p.type),T+="r"+c+`._skip(t);
`;else for(l=u[d].length;l--;)T+=~m&&c>=m?"    ":"  ",k.push("r"+c+"f"+l),_=u[d][l],C.push(_.resolver),T+="var "+_.name+" = ",T+="r"+c+"f"+l+"._"+(l?"peek":"read")+`(t);
`;~m&&(T+=`  }
`),T+="  return new "+v+"("+s.join()+`);
};`,e._read=new Function(k.join(),T).apply(void 0,C)};B.prototype._match=function(e,t){var r=this.fields,n,i,o,s,u;for(n=0,i=r.length;n<i;n++)if(o=r[n],s=o._order,u=o.type,s){if(s*=u._match(e,t),s)return s}else u._skip(e),u._skip(t);return 0};B.prototype._checkFields=function(e){var t=Object.keys(e),r,n;for(r=0,n=t.length;r<n;r++)if(!this._fieldsByName[t[r]])return!1;return!0};B.prototype._copy=function(e,t){var r=t&&t.fieldHook,n=[void 0],i,o,s,u;for(i=0,o=this.fields.length;i<o;i++)s=this.fields[i],u=e[s.name],u===void 0&&s.hasOwnProperty("defaultValue")&&(u=s.defaultValue()),(t&&!t.skip||u!==void 0)&&(u=s.type._copy(u,t)),r&&(u=r(s,u,this)),n.push(u);var c=this.recordConstructor;return new(c.bind.apply(c,n))};B.prototype._deref=function(e,t){e.fields=this.fields.map(function(r){var n=r.type,i={name:r.name,type:n._attrs(t)};if(t.exportAttrs){var o=r.defaultValue();o!==void 0&&(i.default=n._copy(o,{coerce:3,wrap:3}));var s=r.order;s!=="ascending"&&(i.order=s);var u=r.aliases;u.length&&(i.aliases=u);var c=r.doc;c!==void 0&&(i.doc=c)}return i})};B.prototype.compare=function(e,t){var r=this.fields,n,i,o,s,u,c;for(n=0,i=r.length;n<i;n++)if(o=r[n],s=o.name,u=o._order,c=o.type,u&&(u*=c.compare(e[s],t[s]),u))return u;return 0};B.prototype.random=function(){var e=this.fields.map(function(r){return r.type.random()});e.unshift(void 0);var t=this.recordConstructor;return new(t.bind.apply(t,e))};B.prototype.field=function(e){return this._fieldsByName[e]};B.prototype.getField=B.prototype.field;B.prototype.getFields=function(){return this.fields};B.prototype.getRecordConstructor=function(){return this.recordConstructor};Object.defineProperty(B.prototype,"typeName",{enumerable:!0,get:function(){return this._isError?"error":"record"}});function L(e,t){this._logicalTypeName=e.logicalType,f.call(this),Ae=this;try{this._underlyingType=f.forSchema(e,t)}finally{Ae=null;var r=He.length;r&&He[r-1][0]===this&&He.pop()}f.isType(this.underlyingType,"union")?this._branchConstructor=this.underlyingType._branchConstructor:this._branchConstructor=this.underlyingType._createBranchConstructor()}a(L,"LogicalType");P.inherits(L,f);Object.defineProperty(L.prototype,"typeName",{enumerable:!0,get:function(){return"logical:"+this._logicalTypeName}});Object.defineProperty(L.prototype,"underlyingType",{enumerable:!0,get:function(){if(this._underlyingType)return this._underlyingType;var e,t,r;for(e=0,t=He.length;e<t;e++)if(r=He[e],r[0]===this)return r[1]}});L.prototype.getUnderlyingType=function(){return this.underlyingType};L.prototype._read=function(e){return this._fromValue(this.underlyingType._read(e))};L.prototype._write=function(e,t){this.underlyingType._write(e,this._toValue(t))};L.prototype._check=function(e,t,r,n){try{var i=this._toValue(e)}catch{}return i===void 0?(r&&r(e,this),!1):this.underlyingType._check(i,t,r,n)};L.prototype._copy=function(e,t){var r=this.underlyingType;switch(t&&t.coerce){case 3:return r._copy(this._toValue(e),t);case 2:return this._fromValue(r._copy(e,t));default:return this._fromValue(r._copy(this._toValue(e),t))}};L.prototype._update=function(e,t,r){var n=this._resolve(t,r);n&&(e._read=function(i){return n(t._read(i))})};L.prototype.compare=function(e,t){var r=this._toValue(e),n=this._toValue(t);return this.underlyingType.compare(r,n)};L.prototype.random=function(){return this._fromValue(this.underlyingType.random())};L.prototype._deref=function(e,t){var r=this.underlyingType,n=r.name!==void 0&&t.derefed[r.name];return e=r._attrs(t),!n&&t.exportAttrs&&(typeof e=="string"&&(e={type:e}),e.logicalType=this._logicalTypeName,this._export(e)),e};L.prototype._skip=function(e){this.underlyingType._skip(e)};L.prototype._export=function(){};L.prototype._fromValue=w.abstractFunction;L.prototype._toValue=w.abstractFunction;L.prototype._resolve=w.abstractFunction;function D(e){this._concreteTypeName="long",R.call(this,!0),this._noUnpack=!!e}a(D,"AbstractLongType");P.inherits(D,Z);D.prototype.typeName="abstract:long";D.prototype._check=function(e,t,r){var n=this._isValid(e);return!n&&r&&r(e,this),n};D.prototype._read=function(e){var t,r;if(this._noUnpack?(r=e.pos,e.skipLong(),t=e.buf.slice(r,e.pos)):t=e.unpackLongBytes(e),e.isValid())return this._fromBuffer(t)};D.prototype._write=function(e,t){this._isValid(t)||N(t,this);var r=this._toBuffer(t);this._noUnpack?e.writeFixed(r):e.packLongBytes(r)};D.prototype._copy=function(e,t){switch(t&&t.coerce){case 3:return this._toJSON(e);case 2:return this._fromJSON(e);default:return this._fromJSON(this._toJSON(e))}};D.prototype._deref=function(){return"long"};D.prototype._update=function(e,t){var r=this;switch(t.typeName){case"int":e._read=function(n){return r._fromJSON(t._read(n))};break;case"abstract:long":case"long":e._read=function(n){return r._read(n)}}};D.prototype.random=function(){return this._fromJSON(Z.prototype.random())};D.prototype._fromBuffer=w.abstractFunction;D.prototype._toBuffer=w.abstractFunction;D.prototype._fromJSON=w.abstractFunction;D.prototype._toJSON=w.abstractFunction;D.prototype._isValid=w.abstractFunction;D.prototype.compare=w.abstractFunction;function Te(e,t){let r=f.addError;f.addError=u=>{u.fieldName=u.fieldName?e.name+"."+u.fieldName:e.name,r(u)};var n=e.name;(typeof n!="string"||!Ze(n))&&f.addError(new Error(b("invalid field name: %s",n))),this.name=n,this.type=f.forSchema(e.type,t),this.aliases=e.aliases||[],this.doc=e.doc!==void 0?""+e.doc:void 0,this._order=function(u){switch(u){case"ascending":return 1;case"descending":return-1;case"ignore":return 0;default:f.addError(new Error(b("invalid order: %j",u)))}}(e.order===void 0?"ascending":e.order);var i=e.default;if(i===null&&this.type.typeName==="record")f.addError(new Error(b("invalid default for field %s: null is not a %s",this.name,this.type.typeName)));else if(i!==void 0){var o=this.type,s=o._copy(i,{coerce:2,wrap:2});Ve(o.typeName)&&o.typeName!=="bytes"?this.defaultValue=function(){return s}:this.defaultValue=function(){return o._copy(s)}}f.addError=r,Object.freeze(this)}a(Te,"Field");Te.prototype.defaultValue=function(){};Object.defineProperty(Te.prototype,"order",{enumerable:!0,get:function(){return["descending","ignore","ascending"][this._order+1]}});Te.prototype.getAliases=function(){return this.aliases};Te.prototype.getDefault=Te.prototype.defaultValue;Te.prototype.getName=function(){return this.name};Te.prototype.getOrder=function(){return this.order};Te.prototype.getType=function(){return this.type};function zt(e){this._readerType=e,this._read=null,this.itemsType=null,this.size=0,this.symbols=null,this.valuesType=null}a(zt,"Resolver");zt.prototype._peek=f.prototype._peek;zt.prototype.inspect=function(){return"<Resolver>"};function bo(){this.str=void 0}a(bo,"Hash");function tn(e,t,r,n){return r?(r._readerType!==e&&f.addError(new Error("invalid resolver")),r._read(t,n)):e._read(t)}a(tn,"readValue");function $t(e){var t=e.split(".");return t[t.length-1]}a($t,"unqualify");function _t(e,t){~e.indexOf(".")?e=e.replace(/^\./,""):t&&(e=t+"."+e),e.split(".").forEach(function(n){Ze(n)||f.addError(new Error(b("invalid name: %j",e)))});var r=$t(e);return Ve(r)?r:e}a(_t,"qualify");function mt(e){var t={};e.name&&(t[e.name]=!0);var r=e.aliases,n,i;for(n=0,i=r.length;n<i;n++)t[r[n]]=!0;return Object.keys(t)}a(mt,"getAliases");function Ve(e){var t=yt[e];return t&&t.prototype instanceof R}a(Ve,"isPrimitive");function rn(e){if(e==="error")e="record";else{var t=/^([^:]+):(.*)$/.exec(e);t&&(t[1]==="union"?e=t[2]+"Union":e=t[1])}return w.capitalize(e)+"Type"}a(rn,"getClassName");function Dt(e){var t=e.readLong();return t<0&&(t=-t,e.skipLong()),t}a(Dt,"readArraySize");function Gt(e){return e>=-9007199254740990&&e<=9007199254740990}a(Gt,"isSafeLong");function nn(e){return e&&e.type==="Buffer"&&Array.isArray(e.data)}a(nn,"isJsonBuffer");function Ze(e){return go.test(e)}a(Ze,"isValidName");function N(e,t){f.addError(new Error(b("invalid %j: %j",t.schema(),e)))}a(N,"throwInvalidError");function vt(e){var t=e.typeName;switch(t){case"double":case"float":case"int":case"long":return"number";case"bytes":case"fixed":return"buffer";case"enum":return"string";case"map":case"error":case"record":return"object";default:return t}}a(vt,"getTypeBucket");function on(e){if(e===null)return"null";var t=typeof e;if(t==="object"){if(Array.isArray(e))return"array";if(Buffer.isBuffer(e))return"buffer"}return t}a(on,"getValueBucket");function wo(e){var t={},r,n,i,o;for(r=0,n=e.length;r<n;r++)if(o=e[r],!f.isType(o,"logical")){if(i=vt(o),t[i])return!0;t[i]=!0}return!1}a(wo,"isAmbiguous");function Eo(e){var t=["int","long","float","double"],r=-1,n=null,i,o,s,u;for(i=0,o=e.length;i<o;i++)s=e[i],u=t.indexOf(s.typeName),u>r&&(r=u,n=s);return n}a(Eo,"combineNumbers");function To(e,t){var r={},n,i,o,s;for(n=0,i=e.length;n<i;n++){if(o=e[n],o.typeName==="string")return o;s=o.symbols;var u,c;for(u=0,c=s.length;u<c;u++)r[s[u]]=!0}return f.forSchema({type:"enum",symbols:Object.keys(r)},t)}a(To,"combineStrings");function So(e,t){var r=-1,n,i,o;for(n=0,i=e.length;n<i;n++){if(o=e[n],o.typeName==="bytes")return o;r===-1?r=o.size:o.size!==r&&(r=-2)}return r<0?f.forSchema("bytes",t):e[0]}a(So,"combineBuffers");function ko(e,t){var r=[],n={},i={},o=!0,s,u,c,l;for(s=0,u=e.length;s<u;s++)if(c=e[s],c.typeName==="map")o=!1,r.push(c.valuesType);else{l=c.fields;var p,d,h,y,_,m;for(p=0,d=l.length;p<d;p++)h=l[p],_=h.name,m=h.type,r.push(m),o&&(n[_]||(n[_]=[]),n[_].push(m),y=h.defaultValue(),y!==void 0&&(i[_]=y))}if(o){var v=Object.keys(n);for(s=0,u=v.length;s<u;s++)_=v[s],n[_].length<e.length&&i[_]===void 0&&(t&&t.strictDefaults?o=!1:(n[_].unshift(f.forSchema("null",t)),i[_]=null))}var k;return o?k={type:"record",fields:v.map(function(C){var T=f.forTypes(n[C],t),oe=i[C];if(oe!==void 0&&~T.typeName.indexOf("union")){var ge=T.types.slice(),be,ft;for(be=0,ft=ge.length;be<ft&&!ge[be].isValid(oe);be++);if(be>0){var lt=ge[0];ge[0]=ge[be],ge[be]=lt,T=f.forSchema(ge,t)}}return{name:C,type:T,default:i[C]}})}:k={type:"map",values:f.forTypes(r,t)},f.forSchema(k,t)}a(ko,"combineObjects");var sn=[];f.addError=e=>sn.push(e);an.exports={Type:f,getTypeBucket:vt,getValueBucket:on,isPrimitive:Ve,isValidName:Ze,qualify:_t,builtins:function(){var e={LogicalType:L,UnwrappedUnionType:Y,WrappedUnionType:re},t=Object.keys(yt),r,n,i;for(r=0,n=t.length;r<n;r++)i=t[r],e[rn(i)]=yt[i];return e}(),errorsCollector:sn}});var yn=M((gu,hn)=>{"use strict";var ye=gt(),V=qe(),Ne=require("stream"),et=require("util"),cn=require("zlib"),bt={namespace:"org.apache.avro.file"},un=ye.Type.forSchema("long",bt),fn=ye.Type.forSchema({type:"map",values:"bytes"},bt),Yt=ye.Type.forSchema({name:"Header",type:"record",fields:[{name:"magic",type:{type:"fixed",name:"Magic",size:4}},{name:"meta",type:fn},{name:"sync",type:{type:"fixed",name:"Sync",size:16}}]},bt),ln=ye.Type.forSchema({name:"Block",type:"record",fields:[{name:"count",type:"long"},{name:"data",type:"bytes"},{name:"sync",type:"Sync"}]},bt),Qe=V.bufferFrom("Obj"),wt=et.format,Xe=V.Tap;function Et(e,t){t=t||{};var r=!!t.noDecode;Ne.Duplex.call(this,{readableObjectMode:!r,allowHalfOpen:!1}),this._type=ye.Type.forSchema(e),this._tap=new Xe(V.newBuffer(0)),this._writeCb=null,this._needPush=!1,this._readValue=dn(r,this._type),this._finished=!1,this.on("finish",function(){this._finished=!0,this._read()})}a(Et,"RawDecoder");et.inherits(Et,Ne.Duplex);Et.prototype._write=function(e,t,r){this._writeCb=r;var n=this._tap;n.buf=Buffer.concat([n.buf.slice(n.pos),e]),n.pos=0,this._needPush&&(this._needPush=!1,this._read())};Et.prototype._read=function(){this._needPush=!1;var e=this._tap,t=e.pos,r=this._readValue(e);e.isValid()?this.push(r):this._finished?this.push(null):(e.pos=t,this._needPush=!0,this._writeCb&&this._writeCb())};function ae(e){e=e||{};var t=!!e.noDecode;Ne.Duplex.call(this,{allowHalfOpen:!0,readableObjectMode:!t}),this._rType=e.readerSchema!==void 0?ye.Type.forSchema(e.readerSchema):void 0,this._wType=null,this._codecs=e.codecs,this._codec=void 0,this._parseHook=e.parseHook,this._tap=new Xe(V.newBuffer(0)),this._blockTap=new Xe(V.newBuffer(0)),this._syncMarker=null,this._readValue=null,this._noDecode=t,this._queue=new V.OrderedQueue,this._decompress=null,this._index=0,this._remaining=void 0,this._needPush=!1,this._finished=!1,this.on("finish",function(){this._finished=!0,this._needPush&&this._read()})}a(ae,"BlockDecoder");et.inherits(ae,Ne.Duplex);ae.defaultCodecs=function(){return{null:function(e,t){t(null,e)},deflate:cn.inflateRaw}};ae.getDefaultCodecs=ae.defaultCodecs;ae.prototype._decodeHeader=function(){var e=this._tap;if(e.buf.length<Qe.length)return!1;if(!Qe.equals(e.buf.slice(0,Qe.length)))return this.emit("error",new Error("invalid magic bytes")),!1;var t=Yt._read(e);if(!e.isValid())return!1;this._codec=(t.meta["avro.codec"]||"null").toString();var r=this._codecs||ae.getDefaultCodecs();if(this._decompress=r[this._codec],!this._decompress){this.emit("error",new Error(wt("unknown codec: %s",this._codec)));return}try{var n=JSON.parse(t.meta["avro.schema"].toString());this._parseHook&&(n=this._parseHook(n)),this._wType=ye.Type.forSchema(n)}catch(i){this.emit("error",i);return}return this._readValue=dn(this._noDecode,this._wType,this._rType),this._syncMarker=t.sync,this.emit("metadata",this._wType,this._codec,t),!0};ae.prototype._write=function(e,t,r){var n=this._tap;if(n.buf=Buffer.concat([n.buf,e]),n.pos=0,!this._decodeHeader()){process.nextTick(r);return}this._write=this._writeChunk,this._write(V.newBuffer(0),t,r)};ae.prototype._writeChunk=function(e,t,r){var n=this._tap;n.buf=Buffer.concat([n.buf.slice(n.pos),e]),n.pos=0;for(var i=1,o;o=xo(n);){if(!this._syncMarker.equals(o.sync)){this.emit("error",new Error("invalid sync marker"));return}i++,this._decompress(o.data,this._createBlockCallback(o.count,s))}s();function s(){--i||r()}a(s,"chunkCb")};ae.prototype._createBlockCallback=function(e,t){var r=this,n=this._index++;return function(i,o){if(i){var s=new Error(wt("%s codec decompression error",r._codec));s.cause=i,r.emit("error",s),t()}else r._queue.push(new pn(n,o,t,e)),r._needPush&&r._read()}};ae.prototype._read=function(){this._needPush=!1;var e=this._blockTap;if(!this._remaining){var t=this._queue.pop();if(!t||!t.count){this._finished?this.push(null):this._needPush=!0,t&&t.cb();return}t.cb(),this._remaining=t.count,e.buf=t.buf,e.pos=0}this._remaining--,this.push(this._readValue(e))};function Tt(e,t){t=t||{},Ne.Transform.call(this,{writableObjectMode:!0,allowHalfOpen:!1}),this._type=ye.Type.forSchema(e),this._writeValue=function(r,n){try{this._type._write(r,n)}catch(i){this.emit("error",i)}},this._tap=new Xe(V.newBuffer(t.batchSize||65536))}a(Tt,"RawEncoder");et.inherits(Tt,Ne.Transform);Tt.prototype._transform=function(e,t,r){var n=this._tap,i=n.buf,o=n.pos;if(this._writeValue(n,e),!n.isValid()){o&&this.push(Ao(n.buf,0,o));var s=n.pos-o;s>i.length&&(n.buf=V.newBuffer(2*s)),n.pos=0,this._writeValue(n,e)}r()};Tt.prototype._flush=function(e){var t=this._tap,r=t.pos;r&&this.push(t.buf.slice(0,r)),e()};function ue(e,t){t=t||{},Ne.Duplex.call(this,{allowHalfOpen:!0,writableObjectMode:!0});var r;if(ye.Type.isType(e)?(r=e,e=void 0):r=ye.Type.forSchema(e),this._schema=e,this._type=r,this._writeValue=function(i,o){try{this._type._write(i,o)}catch(s){this.emit("error",s)}},this._blockSize=t.blockSize||65536,this._tap=new Xe(V.newBuffer(this._blockSize)),this._codecs=t.codecs,this._codec=t.codec||"null",this._blockCount=0,this._syncMarker=t.syncMarker||new V.Lcg().nextBuffer(16),this._queue=new V.OrderedQueue,this._pending=0,this._finished=!1,this._needHeader=!1,this._needPush=!1,this._metadata=t.metadata||{},!fn.isValid(this._metadata))throw new Error("invalid metadata");var n=this._codec;if(this._compress=(this._codecs||ue.getDefaultCodecs())[n],!this._compress)throw new Error(wt("unsupported codec: %s",n));switch(t.omitHeader!==void 0&&(t.writeHeader=t.omitHeader?"never":"auto"),t.writeHeader){case!1:case"never":break;case void 0:case"auto":this._needHeader=!0;break;default:this._writeHeader()}this.on("finish",function(){this._finished=!0,this._blockCount?this._flushChunk():this._finished&&this._needPush&&this.push(null)})}a(ue,"BlockEncoder");et.inherits(ue,Ne.Duplex);ue.defaultCodecs=function(){return{null:function(e,t){t(null,e)},deflate:cn.deflateRaw}};ue.getDefaultCodecs=ue.defaultCodecs;ue.prototype._writeHeader=function(){var e=JSON.stringify(this._schema?this._schema:this._type.getSchema({exportAttrs:!0})),t=V.copyOwnProperties(this._metadata,{"avro.schema":V.bufferFrom(e),"avro.codec":V.bufferFrom(this._codec)},!0),r=Yt.getRecordConstructor(),n=new r(Qe,t,this._syncMarker);this.push(n.toBuffer())};ue.prototype._write=function(e,t,r){this._needHeader&&(this._writeHeader(),this._needHeader=!1);var n=this._tap,i=n.pos,o=!1;if(this._writeValue(n,e),!n.isValid()){i&&(this._flushChunk(i,r),o=!0);var s=n.pos-i;s>this._blockSize&&(this._blockSize=s*2),n.buf=V.newBuffer(this._blockSize),n.pos=0,this._writeValue(n,e)}this._blockCount++,o||r()};ue.prototype._flushChunk=function(e,t){var r=this._tap;e=e||r.pos,this._compress(r.buf.slice(0,e),this._createBlockCallback(t)),this._blockCount=0};ue.prototype._read=function(){var e=this,t=this._queue.pop();if(!t){this._finished&&!this._pending?process.nextTick(function(){e.push(null)}):this._needPush=!0;return}this.push(un.toBuffer(t.count,!0)),this.push(un.toBuffer(t.buf.length,!0)),this.push(t.buf),this.push(this._syncMarker),this._finished||t.cb()};ue.prototype._createBlockCallback=function(e){var t=this,r=this._index++,n=this._blockCount;return this._pending++,function(i,o){if(i){var s=new Error(wt("%s codec compression error",t._codec));s.cause=i,t.emit("error",s);return}t._pending--,t._queue.push(new pn(r,o,e,n)),t._needPush&&(t._needPush=!1,t._read())}};function pn(e,t,r,n){this.index=e,this.buf=t,this.cb=r,this.count=n|0}a(pn,"BlockData");function xo(e){var t=e.pos,r=ln._read(e);return e.isValid()?r:(e.pos=t,null)}a(xo,"tryReadBlock");function dn(e,t,r){if(e)return function(i){return function(o){var s=o.pos;return i(o),o.buf.slice(s,o.pos)}}(t._skip);if(r){var n=r.createResolver(t);return function(i){return n._read(i)}}else return function(i){return t._read(i)}}a(dn,"createReader");function Ao(e,t,r){var n=V.newBuffer(r);return e.copy(n,0,t,t+r),n}a(Ao,"copyBuffer");hn.exports={BLOCK_TYPE:ln,HEADER_TYPE:Yt,MAGIC_BYTES:Qe,streams:{BlockDecoder:ae,BlockEncoder:ue,RawDecoder:Et,RawEncoder:Tt}}});var Nn=M((wu,An)=>{"use strict";var Zt=gt(),O=qe(),Ce=require("events"),me=require("stream"),x=require("util"),Qt=O.Tap,F=Zt.Type,j=x.debuglog("avsc:services"),q=x.format,_e={namespace:"org.apache.avro.ipc"},_n=F.forSchema("boolean",_e),ve=F.forSchema({type:"map",values:"bytes"},_e),Xt=F.forSchema("string",_e),tt=F.forSchema({name:"HandshakeRequest",type:"record",fields:[{name:"clientHash",type:{name:"MD5",type:"fixed",size:16}},{name:"clientProtocol",type:["null","string"],default:null},{name:"serverHash",type:"MD5"},{name:"meta",type:["null",ve],default:null}]},_e),rt=F.forSchema({name:"HandshakeResponse",type:"record",fields:[{name:"match",type:{name:"HandshakeMatch",type:"enum",symbols:["BOTH","CLIENT","NONE"]}},{name:"serverProtocol",type:["null","string"],default:null},{name:"serverHash",type:["null","MD5"],default:null},{name:"meta",type:["null",ve],default:null}]},_e),er=16,tr=new xe("",F.forSchema({name:"PingRequest",type:"record",fields:[]},_e),F.forSchema(["string"],_e),F.forSchema("null",_e));function xe(e,t,r,n,i,o){if(this.name=e,!F.isType(t,"record"))throw new Error("invalid request type");if(this.requestType=t,!F.isType(r,"union")||!F.isType(r.getTypes()[0],"string"))throw new Error("invalid error type");if(this.errorType=r,i&&(!F.isType(n,"null")||r.getTypes().length>1))throw new Error("inapplicable one-way parameter");this.responseType=n,this.oneWay=!!i,this.doc=o!==void 0?""+o:void 0,Object.freeze(this)}a(xe,"Message");xe.forSchema=function(e,t,r){if(r=r||{},!Zt.isValidName(e))throw new Error(q("invalid message name: %s",e));if(!Array.isArray(t.request))throw new Error(q("invalid message request: %s",e));var n=q("%s.%sRequest",_e.namespace,O.capitalize(e)),i=F.forSchema({name:n,type:"record",namespace:r.namespace||"",fields:t.request},r);if(delete r.registry[n],!t.response)throw new Error(q("invalid message response: %s",e));var o=F.forSchema(t.response,r);if(t.errors!==void 0&&!Array.isArray(t.errors))throw new Error(q("invalid message errors: %s",e));var s=F.forSchema(["string"].concat(t.errors||[]),r),u=!!t["one-way"];return new xe(e,i,s,o,u,t.doc)};xe.prototype.schema=F.prototype.getSchema;xe.prototype._attrs=function(e){var t=this.requestType._attrs(e),r={request:t.fields,response:this.responseType._attrs(e)},n=this.doc;n!==void 0&&(r.doc=n);var i=this.errorType._attrs(e);return i.length>1&&(r.errors=i.slice(1)),this.oneWay&&(r["one-way"]=!0),r};O.addDeprecatedGetters(xe,["name","errorType","requestType","responseType"]);xe.prototype.isOneWay=x.deprecate(function(){return this.oneWay},"use `.oneWay` directly instead of `.isOneWay()`");function E(e,t,r,n,i){if(typeof e!="string")return E.forProtocol(e,t);this.name=e,this._messagesByName=t||{},this.messages=Object.freeze(O.objectValues(this._messagesByName)),this._typesByName=r||{},this.types=Object.freeze(O.objectValues(this._typesByName)),this.protocol=n,this._hashStr=O.getHash(JSON.stringify(n)).toString("binary"),this.doc=n.doc?""+n.doc:void 0,this._server=i||this.createServer({silent:!0}),Object.freeze(this)}a(E,"Service");E.Client=X;E.Server=ce;E.compatible=function(e,t){try{gn(e,t)}catch{return!1}return!0};E.forProtocol=function(e,t){t=t||{};var r=e.protocol;if(!r)throw new Error("missing protocol name");if(e.namespace!==void 0)t.namespace=e.namespace;else{var n=/^(.*)\.[^.]+$/.exec(r);n&&(t.namespace=n[1])}r=Zt.qualify(r,t.namespace),e.types&&e.types.forEach(function(o){F.forSchema(o,t)});var i;return e.messages&&(i={},Object.keys(e.messages).forEach(function(o){i[o]=xe.forSchema(o,e.messages[o],t)})),new E(r,i,t.registry,e)};E.isService=function(e){return!!e&&e.hasOwnProperty("_hashStr")};E.prototype.createClient=function(e){var t=new X(this,e);return process.nextTick(function(){if(e&&e.server){var r={objectMode:!0},n=[new me.PassThrough(r),new me.PassThrough(r)];e.server.createChannel({readable:n[0],writable:n[1]},r),t.createChannel({readable:n[1],writable:n[0]},r)}else e&&e.transport&&t.createChannel(e.transport)}),t};E.prototype.createServer=function(e){return new ce(this,e)};Object.defineProperty(E.prototype,"hash",{enumerable:!0,get:function(){return O.bufferFrom(this._hashStr,"binary")}});E.prototype.message=function(e){return this._messagesByName[e]};E.prototype.type=function(e){return this._typesByName[e]};E.prototype.inspect=function(){return q("<Service %j>",this.name)};O.addDeprecatedGetters(E,["message","messages","name","type","types"]);E.prototype.createEmitter=x.deprecate(function(e,t){t=t||{};var r=this.createClient({cache:t.cache,buffering:!1,strictTypes:t.strictErrors,timeout:t.timeout}),n=r.createChannel(e,t);return Oo(r,n),n},"use `.createClient()` instead of `.createEmitter()`");E.prototype.createListener=x.deprecate(function(e,t){if(t&&t.strictErrors)throw new Error("use `.createServer()` to support strict errors");return this._server.createChannel(e,t)},"use `.createServer().createChannel()` instead of `.createListener()`");E.prototype.emit=x.deprecate(function(e,t,r,n){if(!r||!this.equals(r.client._svc$))throw new Error("invalid emitter");var i=r.client;return X.prototype.emitMessage.call(i,e,t,n&&n.bind(this)),r.getPending()},"create a client via `.createClient()` to emit messages instead of `.emit()`");E.prototype.equals=x.deprecate(function(e){return E.isService(e)&&this.getFingerprint().equals(e.getFingerprint())},"equality testing is deprecated, compare the `.protocol`s instead");E.prototype.getFingerprint=x.deprecate(function(e){return O.getHash(JSON.stringify(this.protocol),e)},"use `.hash` instead of `.getFingerprint()`");E.prototype.getSchema=x.deprecate(F.prototype.getSchema,"use `.protocol` instead of `.getSchema()`");E.prototype.on=x.deprecate(function(e,t){var r=this;return this._server.onMessage(e,function(n,i){return t.call(r,n,this.channel,i)}),this},"use `.createServer().onMessage()` instead of `.on()`");E.prototype.subprotocol=x.deprecate(function(){var e=this._server,t={strictTypes:e._strict,cache:e._cache},r=new ce(e.service,t);return r._handlers=Object.create(e._handlers),new E(this.name,this._messagesByName,this._typesByName,this.protocol,r)},"`.subprotocol()` will be removed in 5.1");E.prototype._attrs=function(e){var t={protocol:this.name},r=[];this.types.forEach(function(i){if(i.getName()!==void 0){var o=i._attrs(e);typeof o!="string"&&r.push(o)}}),r.length&&(t.types=r);var n=Object.keys(this._messagesByName);return n.length&&(t.messages={},n.forEach(function(i){t.messages[i]=this._messagesByName[i]._attrs(e)},this)),e&&e.exportAttrs&&this.doc!==void 0&&(t.doc=this.doc),t};function No(e,t,r){r===void 0&&typeof t=="function"&&(r=t,t=void 0);var n=new E({protocol:"Empty"},_e),i;n.createClient({timeout:t&&t.timeout}).createChannel(e,{scope:t&&t.scope,endWritable:typeof e=="function"}).once("handshake",function(o,s){i=s.serverProtocol,this.destroy(!0)}).once("eot",function(o,s){s&&!/interrupted/.test(s)?r(s):r(null,JSON.parse(i))})}a(No,"discoverProtocol");function X(e,t){t=t||{},Ce.EventEmitter.call(this),this._svc$=e,this._channels$=[],this._fns$=[],this._buffering$=!!t.buffering,this._cache$=t.cache||{},this._policy$=t.channelPolicy,this._strict$=!!t.strictTypes,this._timeout$=O.getOption(t,"timeout",1e4),t.remoteProtocols&&bn(this._cache$,t.remoteProtocols,e,!0),this._svc$.messages.forEach(function(r){this[r.name]=this._createMessageHandler$(r)},this)}a(X,"Client");x.inherits(X,Ce.EventEmitter);X.prototype.activeChannels=function(){return this._channels$.slice()};X.prototype.createChannel=function(e,t){var r=t&&t.objectMode,n;if(typeof e=="function"){var i;r?i=e:i=a(function(p){var d=new it,h=e(function(y,_){if(y){p(y);return}var m=new Me().once("error",function(v){n.destroy(v)});p(null,_.pipe(m))});if(h)return d.pipe(h),d},"writableFactory"),n=new rr(this,i,t)}else{var o,s;if(Sn(e)?o=s=e:(o=e.readable,s=e.writable),!r){var u=new Ue;o=o.pipe(u);var c=new ot;c.pipe(s),s=c}n=new kt(this,o,s,t),r||(n.once("eot",function(){o.unpipe(u),c.unpipe(s)}),u.once("error",function(p){n.destroy(p)}))}var l=this._channels$;return l.push(n),n.once("_drain",function(){l.splice(l.indexOf(this),1)}),this._buffering$=!1,this.emit("channel",n),n};X.prototype.destroyChannels=function(e){this._channels$.forEach(function(t){t.destroy(e&&e.noWait)})};X.prototype.emitMessage=function(e,t,r,n){var i=kn(this._svc$,e),o=new xt(i,{},t);this._emitMessage$(o,r,n)};X.prototype.remoteProtocols=function(){return wn(this._cache$,!0)};Object.defineProperty(X.prototype,"service",{enumerable:!0,get:function(){return this._svc$}});X.prototype.use=function(){var e,t,r;for(e=0,t=arguments.length;e<t;e++)r=arguments[e],this._fns$.push(r.length<3?r(this):r);return this};X.prototype._emitMessage$=function(e,t,r){!r&&typeof t=="function"&&(r=t,t=void 0);var n=this,i=this._channels$,o=i.length;if(!o){if(this._buffering$)j("no active client channels, buffering call"),this.once("channel",function(){this._emitMessage$(e,t,r)});else{var s=new Error("no active channels");process.nextTick(function(){r?r.call(new ir(e._msg),s):n.emit("error",s)})}return}t=t||{},t.timeout===void 0&&(t.timeout=this._timeout$);var u;if(o===1)u=i[0];else if(this._policy$){if(u=this._policy$(this._channels$.slice()),!u){j("policy returned no channel, skipping call");return}}else u=i[Math.floor(Math.random()*o)];u._emit(e,t,function(c,l){var p=this,d=p.message.errorType;if(c){n._strict$&&(c=d.clone(c.message,{wrapUnions:!0})),h(c);return}if(!l){h();return}c=l.error,n._strict$||(c===void 0?c=null:F.isType(d,"union:unwrapped")?typeof c=="string"&&(c=new Error(c)):c&&c.string&&typeof c.string=="string"&&(c=new Error(c.string))),h(c,l.response);function h(y,_){r?r.call(p,y,_):y&&n.emit("error",y)}a(h,"done")})};X.prototype._createMessageHandler$=function(e){var t=e.requestType.getFields(),r=t.map(function(i){return i.getName()}),n="return function "+e.name+"(";return r.length&&(n+=r.join(", ")+", "),n+=`opts, cb) {
`,n+="  var req = {",n+=r.map(function(i){return i+": "+i}).join(", "),n+=`};
`,n+="  return this.emitMessage('"+e.name+`', req, opts, cb);
`,n+="};",new Function(n)()};function ce(e,t){t=t||{},Ce.EventEmitter.call(this),this.service=e,this._handlers={},this._fns=[],this._channels={},this._nextChannelId=1,this._cache=t.cache||{},this._defaultHandler=t.defaultHandler,this._sysErrFormatter=t.systemErrorFormatter,this._silent=!!t.silent,this._strict=!!t.strictTypes,t.remoteProtocols&&bn(this._cache,t.remoteProtocols,e,!1),e.messages.forEach(function(r){var n=r.name;t.noCapitalize||(n=O.capitalize(n)),this["on"+n]=this._createMessageHandler(r)},this)}a(ce,"Server");x.inherits(ce,Ce.EventEmitter);ce.prototype.activeChannels=function(){return O.objectValues(this._channels)};ce.prototype.createChannel=function(e,t){var r=t&&t.objectMode,n;if(typeof e=="function"){var i;r?i=e:i=a(function(d){var h=new Me().once("error",function(y){n.destroy(y)});return e(function(y,_){if(y){d(y);return}var m=new it;m.pipe(_),d(null,m)}).pipe(h)},"readableFactory"),n=new mn(this,i,t)}else{var o,s;if(Sn(e)?o=s=e:(o=e.readable,s=e.writable),!r){var u=new Ue;o=o.pipe(u);var c=new ot;c.pipe(s),s=c}n=new vn(this,o,s,t),r||(n.once("eot",function(){o.unpipe(u),c.unpipe(s)}),u.once("error",function(d){n.destroy(d)}))}this.listeners("error").length||this.on("error",this._onError);var l=this._nextChannelId++,p=this._channels;return p[l]=n.once("eot",function(){delete p[l]}),this.emit("channel",n),n};ce.prototype.onMessage=function(e,t){return kn(this.service,e),this._handlers[e]=t,this};ce.prototype.remoteProtocols=function(){return wn(this._cache,!1)};ce.prototype.use=function(){var e,t,r;for(e=0,t=arguments.length;e<t;e++)r=arguments[e],this._fns.push(r.length<3?r(this):r);return this};ce.prototype._createMessageHandler=function(e){var t=e.name,r=e.requestType.fields,n=r.length,i=r.length?", "+r.map(function(s){return"req."+s.name}).join(", "):"",o=`return function (handler) {
`;return o+="  if (handler.length > "+n+`) {
`,o+="    return this.onMessage('"+t+`', function (req, cb) {
`,o+="      return handler.call(this"+i+`, cb);
`,o+=`    });
`,o+=`  } else {
`,o+="    return this.onMessage('"+t+`', function (req) {
`,o+="      return handler.call(this"+i+`);
`,o+=`    });
`,o+=`  }
`,o+=`};
`,new Function(o)()};ce.prototype._onError=function(e){!this._silent&&e.rpcCode!=="UNKNOWN_PROTOCOL"&&(console.error(),e.rpcCode?(console.error(e.rpcCode),console.error(e.cause)):(console.error("INTERNAL_SERVER_ERROR"),console.error(e)))};function U(e,t){t=t||{},Ce.EventEmitter.call(this),this.client=e,this.timeout=O.getOption(t,"timeout",e._timeout$),this._endWritable=!!O.getOption(t,"endWritable",!0),this._prefix=En(t.scope);var r=e._cache$,n=e._svc$,i=t.serverHash;i||(i=n.hash);var o=r[i];o||(i=n.hash,o=r[i]=new Re(n,n,i)),this._adapter=o,this._registry=new nt(this,er),this.pending=0,this.destroyed=!1,this.draining=!1,this.once("_eot",function(s,u){j("client channel EOT"),this.destroyed=!0,this.emit("eot",s,u)})}a(U,"ClientChannel");x.inherits(U,Ce.EventEmitter);U.prototype.destroy=function(e){j("destroying client channel"),this.draining||(this.draining=!0,this.emit("_drain"));var t=this._registry,r=this.pending;e&&t.clear(),e||!r?or(e)?(j("fatal client channel error: %s",e),this.emit("_eot",r,e)):this.emit("_eot",r):j("client channel entering drain mode (%s pending)",r)};U.prototype.ping=function(e,t){!t&&typeof e=="function"&&(t=e,e=void 0);var r=this,n=new xt(tr);this._emit(n,{timeout:e},function(i){t?t.call(r,i):i&&r.destroy(i)})};U.prototype._createHandshakeRequest=function(e,t){var r=this.client._svc$;return{clientHash:r.hash,clientProtocol:t?null:JSON.stringify(r.protocol),serverHash:e._hash}};U.prototype._emit=function(e,t,r){var n=e._msg,i=n.oneWay?void 0:new nr(n,{}),o=new ir(n,this),s=this;this.pending++,process.nextTick(function(){if(!n.name)u(e,i,c);else{s.emit("outgoingCall",o,t);var p=s.client._fns$;j("starting client middleware chain (%s middleware)",p.length),xn({fns:p,ctx:o,wreq:e,wres:i,onTransition:u,onCompletion:c,onError:l})}});function u(p,d,h){var y,_;if(s.destroyed)y=new Error("channel destroyed");else try{_=p.toBuffer()}catch{y=Kt(q("invalid %j request",n.name),p,[{name:"headers",type:ve},{name:"request",type:n.requestType}])}if(y){h(y);return}var m=t&&t.timeout!==void 0?t.timeout:s.timeout,v=s._registry.add(m,function(k,C,T){if(!k&&!n.oneWay)try{T._decodeResponse(C,d,n)}catch(oe){k=oe}h(k)});v|=s._prefix,j("sending message %s",v),s._send(v,_,!!n&&n.oneWay)}a(u,"onTransition");function c(p){s.pending--,r.call(o,p,i),s.draining&&!s.destroyed&&!s.pending&&s.destroy()}a(c,"onCompletion");function l(p){s.client.emit("error",p,s)}a(l,"onError")};U.prototype._getAdapter=function(e){var t=e.serverHash,r=this.client._cache$,n=r[t];if(n)return n;var i=JSON.parse(e.serverProtocol),o=E.forProtocol(i);return n=new Re(this.client._svc$,o,t,!0),r[t]=n};U.prototype._matchesPrefix=function(e){return Tn(e,this._prefix)};U.prototype._send=O.abstractFunction;O.addDeprecatedGetters(U,["pending","timeout"]);U.prototype.getCache=x.deprecate(function(){return this.client._cache$},"use `.remoteProtocols()` instead of `.getCache()`");U.prototype.getProtocol=x.deprecate(function(){return this.client._svc$},"use `.service` instead or `.getProtocol()`");U.prototype.isDestroyed=x.deprecate(function(){return this.destroyed},"use `.destroyed` instead of `.isDestroyed`");function rr(e,t,r){U.call(this,e,r),this._writableFactory=t,(!r||!r.noPing)&&(j("emitting ping request"),this.ping())}a(rr,"StatelessClientChannel");x.inherits(rr,U);rr.prototype._send=function(e,t){var r=this._registry.get(e),n=this._adapter,i=this;return process.nextTick(o),!0;function o(s){if(!i.destroyed){var u=i._createHandshakeRequest(n,!s),c=i._writableFactory.call(i,function(l,p){if(l){r(l);return}p.on("data",function(d){j("received response %s",d.id);var h=Buffer.concat(d.payload);try{var y=At(rt,h),_=y.head;_.serverHash&&(n=i._getAdapter(_))}catch(v){r(v);return}var m=_.match;j("handshake match: %s",m),i.emit("handshake",u,_),m==="NONE"?process.nextTick(function(){o(!0)}):(i._adapter=n,r(null,y.tail,n))})});if(!c){r(new Error("invalid writable stream"));return}c.write({id:e,payload:[tt.toBuffer(u),t]}),i._endWritable&&c.end()}}a(o,"emit")};function kt(e,t,r,n){U.call(this,e,n),this._readable=t,this._writable=r,this._connected=!!(n&&n.noPing),this._readable.on("end",p),this._writable.on("finish",d);var i=this,o=null;this.once("eot",function(){o&&(clearTimeout(o),o=null),i._connected||i.emit("_ready"),this._writable.removeListener("finish",d),this._endWritable&&(j("ending transport"),this._writable.end()),this._readable.removeListener("data",c).removeListener("data",l).removeListener("end",p)});var s;this._connected?this._readable.on("data",l):(this._readable.on("data",c),process.nextTick(u),i.timeout&&(o=setTimeout(function(){i.destroy(new Error("timeout"))},i.timeout)));function u(h){if(!i.destroyed){s=i._createHandshakeRequest(i._adapter,!h);var y=[tt.toBuffer(s),O.bufferFrom([0,0])];i._writable.write({id:i._prefix,payload:y})}}a(u,"ping");function c(h){if(!i._matchesPrefix(h.id)){j("discarding unscoped response %s (still connecting)",h.id);return}var y=Buffer.concat(h.payload);try{var _=At(rt,y).head;_.serverHash&&(i._adapter=i._getAdapter(_))}catch(v){i.destroy(v);return}var m=_.match;j("handshake match: %s",m),i.emit("handshake",s,_),m==="NONE"?process.nextTick(function(){u(!0)}):(j("successfully connected"),o&&(clearTimeout(o),o=null),i._readable.removeListener("data",c).on("data",l),i._connected=!0,i.emit("_ready"),s=null)}a(c,"onPing");function l(h){var y=h.id;if(!i._matchesPrefix(y)){j("discarding unscoped message %s",y);return}var _=i._registry.get(y);_&&process.nextTick(function(){j("received message %s",y),_(null,Buffer.concat(h.payload),i._adapter)})}a(l,"onMessage");function p(){i.destroy(!0)}a(p,"onEnd");function d(){i.destroy()}a(d,"onFinish")}a(kt,"StatefulClientChannel");x.inherits(kt,U);kt.prototype._emit=function(){if(this._connected||this.draining)U.prototype._emit.apply(this,arguments);else{j("queuing request");var e=[],t,r;for(t=0,r=arguments.length;t<r;t++)e.push(arguments[t]);this.once("_ready",function(){this._emit.apply(this,e)})}};kt.prototype._send=function(e,t,r){if(r){var n=this;process.nextTick(function(){n._registry.get(e)(null,O.bufferFrom([0,0,0]),n._adapter)})}return this._writable.write({id:e,payload:[t]})};function G(e,t){t=t||{},Ce.EventEmitter.call(this),this.server=e,this._endWritable=!!O.getOption(t,"endWritable",!0),this._prefix=En(t.scope);var r=e._cache,n=e.service,i=n.hash;r[i]||(r[i]=new Re(n,n,i)),this._adapter=null,this.destroyed=!1,this.draining=!1,this.pending=0,this.once("_eot",function(o,s){j("server channel EOT"),this.emit("eot",o,s)})}a(G,"ServerChannel");x.inherits(G,Ce.EventEmitter);G.prototype.destroy=function(e){this.draining||(this.draining=!0,this.emit("_drain")),(e||!this.pending)&&(this.destroyed=!0,or(e)?(j("fatal server channel error: %s",e),this.emit("_eot",this.pending,e)):this.emit("_eot",this.pending))};G.prototype._createHandshakeResponse=function(e,t){var r=this.server.service,n=r.hash,i=t&&t.serverHash.equals(n);return{match:e?"NONE":i?"BOTH":"CLIENT",serverProtocol:i?null:JSON.stringify(r.protocol),serverHash:i?null:n}};G.prototype._getAdapter=function(e){var t=e.clientHash,r=this.server._cache[t];if(r)return r;if(!e.clientProtocol)throw Oe("UNKNOWN_PROTOCOL");var n=JSON.parse(e.clientProtocol),i=E.forProtocol(n);return r=new Re(i,this.server.service,t,!0),this.server._cache[t]=r};G.prototype._matchesPrefix=function(e){return Tn(e,this._prefix)};G.prototype._receive=function(e,t,r){var n=this,i;try{i=t._decodeRequest(e)}catch(h){r(n._encodeSystemError(Oe("INVALID_REQUEST",h)));return}var o=i._msg,s=new nr(o,{});if(!o.name){s.response=null,r(s.toBuffer(),!1);return}var u=new ir(o,this);n.emit("incomingCall",u);var c=this.server._fns;j("starting server middleware chain (%s middleware)",c.length),n.pending++,xn({fns:c,ctx:u,wreq:i,wres:s,onTransition:l,onCompletion:p,onError:d});function l(h,y,_){var m=n.server._handlers[o.name];if(m){var C=!o.oneWay;try{C?m.call(u,h.request,function(T,oe){C=!1,y.error=T,y.response=oe,_()}):(m.call(u,h.request),_())}catch(T){C?(C=!1,_(T)):d(T)}}else{var v=n.server._defaultHandler;if(v)v.call(u,h,y,_);else{var k=new Error(q("no handler for %s",o.name));_(Oe("NOT_IMPLEMENTED",k))}}}a(l,"onTransition");function p(h){n.pending--;var y=n.server,_;if(!h){var m=s.error,v=y._strict;v||(or(m)?s.error=o.errorType.clone(m.message,{wrapUnions:!0}):m===null&&(m=s.error=void 0),m===void 0&&s.response===void 0&&o.responseType.isValid(null)&&(s.response=null));try{_=s.toBuffer()}catch{s.error!==void 0?h=Kt(q("invalid %j error",o.name),s,[{name:"headers",type:ve},{name:"error",type:o.errorType}]):h=Kt(q("invalid %j response",o.name),s,[{name:"headers",type:ve},{name:"response",type:o.responseType}])}}_?m!==void 0&&y.emit("error",Oe("APPLICATION_ERROR",m)):_=n._encodeSystemError(h,s.headers),r(_,o.oneWay),n.draining&&!n.pending&&n.destroy()}a(p,"onCompletion");function d(h){n.server.emit("error",h,n)}a(d,"onError")};O.addDeprecatedGetters(G,["pending"]);G.prototype.getCache=x.deprecate(function(){return this.server._cache},"use `.remoteProtocols()` instead of `.getCache()`");G.prototype.getProtocol=x.deprecate(function(){return this.server.service},"use `.service` instead of `.getProtocol()`");G.prototype.isDestroyed=x.deprecate(function(){return this.destroyed},"use `.destroyed` instead of `.isDestroyed`");G.prototype._encodeSystemError=function(e,t){var r=this.server;r.emit("error",e,this);var n;r._sysErrFormatter?n=r._sysErrFormatter.call(this,e):e.rpcCode&&(n=e.message);var i;if(t)try{i=ve.toBuffer(t)}catch(o){r.emit("error",o,this)}return Buffer.concat([i||O.bufferFrom([0]),O.bufferFrom([1,0]),Xt.toBuffer(n||"internal server error")])};function mn(e,t,r){G.call(this,e,r),this._writable=void 0;var n=this,i;process.nextTick(function(){i=t.call(n,function(c,l){process.nextTick(function(){if(c){u(c);return}n._writable=l.on("finish",u),n.emit("_writable")})}).on("data",o).on("end",s)});function o(c){var l=c.id,p=Buffer.concat(c.payload),d;try{var h=At(tt,p),y=h.head,_=n._getAdapter(y)}catch(k){d=Oe("INVALID_HANDSHAKE_REQUEST",k)}var m=n._createHandshakeResponse(d,y);n.emit("handshake",y,m),d?v(n._encodeSystemError(d)):n._receive(h.tail,_,v);function v(k){if(!n.destroyed){if(!n._writable){n.once("_writable",function(){v(k)});return}n._writable.write({id:l,payload:[rt.toBuffer(m),k]})}n._writable&&n._endWritable&&n._writable.end()}a(v,"done")}a(o,"onRequest");function s(){n.destroy()}a(s,"onEnd");function u(c){i.removeListener("data",o).removeListener("end",s),n.destroy(c||!0)}a(u,"onFinish")}a(mn,"StatelessServerChannel");x.inherits(mn,G);function vn(e,t,r,n){G.call(this,e,n),this._adapter=void 0,this._writable=r.on("finish",c),this._readable=t.on("data",o).on("end",u),this.once("_drain",function(){this._readable.removeListener("data",o).removeListener("data",s).removeListener("end",u)}).once("eot",function(){this._writable.removeListener("finish",c),this._endWritable&&this._writable.end()});var i=this;function o(l){var p=l.id;if(!i._matchesPrefix(p))return;var d=Buffer.concat(l.payload),h;try{var y=At(tt,d),_=y.head;i._adapter=i._getAdapter(_)}catch(k){h=Oe("INVALID_HANDSHAKE_REQUEST",k)}var m=i._createHandshakeResponse(h,_);i.emit("handshake",_,m),h?v(i._encodeSystemError(h)):(i._readable.removeListener("data",o).on("data",s),i._receive(y.tail,i._adapter,v));function v(k){i.destroyed||i._writable.write({id:p,payload:[rt.toBuffer(m),k]})}a(v,"done")}a(o,"onHandshake");function s(l){var p=l.id;if(i._matchesPrefix(p)){var d=Buffer.concat(l.payload);i._receive(d,i._adapter,function(h,y){i.destroyed||y||i._writable.write({id:p,payload:[h]})})}}a(s,"onRequest");function u(){i.destroy()}a(u,"onEnd");function c(){i.destroy(!0)}a(c,"onFinish")}a(vn,"StatefulServerChannel");x.inherits(vn,G);function xt(e,t,r){this._msg=e,this.headers=t||{},this.request=r||{}}a(xt,"WrappedRequest");xt.prototype.toBuffer=function(){var e=this._msg;return Buffer.concat([ve.toBuffer(this.headers),Xt.toBuffer(e.name),e.requestType.toBuffer(this.request)])};function nr(e,t,r,n){this._msg=e,this.headers=t,this.error=r,this.response=n}a(nr,"WrappedResponse");nr.prototype.toBuffer=function(){var e=ve.toBuffer(this.headers),t=this.error!==void 0;return Buffer.concat([e,_n.toBuffer(t),t?this._msg.errorType.toBuffer(this.error):this._msg.responseType.toBuffer(this.response)])};function ir(e,t){this.channel=t,this.locals={},this.message=e,Object.freeze(this)}a(ir,"CallContext");function nt(e,t){this._ctx=e,this._mask=-1>>>(t|0),this._id=0,this._n=0,this._cbs={}}a(nt,"Registry");nt.prototype.get=function(e){return this._cbs[e&this._mask]};nt.prototype.add=function(e,t){this._id=this._id+1&this._mask;var r=this,n=this._id,i;return e>0&&(i=setTimeout(function(){o(new Error("timeout"))},e)),this._cbs[n]=o,this._n++,n;function o(){r._cbs[n]&&(delete r._cbs[n],r._n--,i&&clearTimeout(i),t.apply(r._ctx,arguments))}a(o,"cb")};nt.prototype.clear=function(){Object.keys(this._cbs).forEach(function(e){this._cbs[e](new Error("interrupted"))},this)};function Re(e,t,r,n){this._clientSvc=e,this._serverSvc=t,this._hash=r,this._isRemote=!!n,this._readers=gn(e,t)}a(Re,"Adapter");Re.prototype._decodeRequest=function(e){var t=new Qt(e),r=ve._read(t),n=Xt._read(t),i,o;if(n?(i=this._serverSvc.message(n),o=this._readers[n+"?"]._read(t)):i=tr,!t.isValid())throw new Error(q("truncated %s request",n||"ping$"));return new xt(i,r,o)};Re.prototype._decodeResponse=function(e,t,r){var n=new Qt(e);O.copyOwnProperties(ve._read(n),t.headers,!0);var i=_n._read(n),o=r.name;if(o){var s=this._readers[o+(i?"*":"!")];if(r=this._clientSvc.message(o),i?t.error=s._read(n):t.response=s._read(n),!n.isValid())throw new Error(q("truncated %s response",o))}else r=tr};function Me(){me.Transform.call(this,{readableObjectMode:!0}),this._id=void 0,this._buf=O.newBuffer(0),this._bufs=[],this.on("finish",function(){this.push(null)})}a(Me,"FrameDecoder");x.inherits(Me,me.Transform);Me.prototype._transform=function(e,t,r){e=Buffer.concat([this._buf,e]);for(var n;e.length>=4&&e.length>=(n=e.readInt32BE(0))+4;){if(n)this._bufs.push(e.slice(4,n+4));else{var i=this._bufs;this._bufs=[],this.push({id:null,payload:i})}e=e.slice(n+4)}this._buf=e,r()};Me.prototype._flush=function(){if(this._buf.length||this._bufs.length){var e=this._bufs.slice();e.unshift(this._buf);var t=Oe("TRAILING_DATA");t.trailingData=Buffer.concat(e).toString(),this.emit("error",t)}};function it(){me.Transform.call(this,{writableObjectMode:!0}),this.on("finish",function(){this.push(null)})}a(it,"FrameEncoder");x.inherits(it,me.Transform);it.prototype._transform=function(e,t,r){var n=e.payload,i,o,s;for(i=0,o=n.length;i<o;i++)s=n[i],this.push(Wt(s.length)),this.push(s);this.push(Wt(0)),r()};function Ue(){me.Transform.call(this,{readableObjectMode:!0}),this._id=void 0,this._frameCount=0,this._buf=O.newBuffer(0),this._bufs=[],this.on("finish",function(){this.push(null)})}a(Ue,"NettyDecoder");x.inherits(Ue,me.Transform);Ue.prototype._transform=function(e,t,r){for(e=Buffer.concat([this._buf,e]);;){if(this._id===void 0){if(e.length<8){this._buf=e,r();return}this._id=e.readInt32BE(0),this._frameCount=e.readInt32BE(4),e=e.slice(8)}for(var n;this._frameCount&&e.length>=4&&e.length>=(n=e.readInt32BE(0))+4;)this._frameCount--,this._bufs.push(e.slice(4,n+4)),e=e.slice(n+4);if(this._frameCount){this._buf=e,r();return}else{var i={id:this._id,payload:this._bufs};this._bufs=[],this._id=void 0,this.push(i)}}};Ue.prototype._flush=Me.prototype._flush;function ot(){me.Transform.call(this,{writableObjectMode:!0}),this.on("finish",function(){this.push(null)})}a(ot,"NettyEncoder");x.inherits(ot,me.Transform);ot.prototype._transform=function(e,t,r){var n=e.payload,i=n.length,o;o=O.newBuffer(8),o.writeInt32BE(e.id,0),o.writeInt32BE(i,4),this.push(o);var s;for(s=0;s<i;s++)o=n[s],this.push(Wt(o.length)),this.push(o);r()};function Wt(e){var t=O.newBuffer(4);return t.writeInt32BE(e),t}a(Wt,"intBuffer");function At(e,t){var r=new Qt(t),n=e._read(r);if(!r.isValid())throw new Error(q("truncated %j",e.schema()));return{head:n,tail:r.buf.slice(r.pos)}}a(At,"readHead");function Jt(e,t){return e.equals(t)?e:e.createResolver(t)}a(Jt,"createReader");function gn(e,t){var r={};return e.messages.forEach(function(n){var i=n.name,o=t.message(i);try{if(!o)throw new Error(q("missing server message: %s",i));if(o.oneWay!==n.oneWay)throw new Error(q("inconsistent one-way message: %s",i));r[i+"?"]=Jt(o.requestType,n.requestType),r[i+"*"]=Jt(n.errorType,o.errorType),r[i+"!"]=Jt(n.responseType,o.responseType)}catch(s){throw Oe("INCOMPATIBLE_PROTOCOL",s)}}),r}a(gn,"createReaders");function bn(e,t,r,n){Object.keys(t).forEach(function(i){var o=t[i],s,u;n?(s=r,u=E.forProtocol(o)):(s=E.forProtocol(o),u=r),e[i]=new Re(s,u,i,!0)})}a(bn,"insertRemoteProtocols");function wn(e,t){var r={};return Object.keys(e).forEach(function(n){var i=e[n];if(i._isRemote){var o=t?i._serverSvc:i._clientSvc;r[n]=o.protocol}}),r}a(wn,"getRemoteProtocols");function or(e){return!!e&&Object.prototype.toString.call(e)==="[object Error]"}a(or,"isError");function Oo(e,t){return e.on("error",function(r){t.emit("error",r,e)})}a(Oo,"forwardErrors");function St(e,t){var r=new Error(e);return r.cause=t,r}a(St,"toError");function Oe(e,t){var r=St(e.toLowerCase().replace(/_/g," "),t);return r.rpcCode=t&&t.rpcCode?t.rpcCode:e,r}a(Oe,"toRpcError");function Kt(e,t,r){var n=[],i,o,s;for(i=0,o=r.length;i<o;i++)s=r[i],s.type.isValid(t[s.name],{errorHook:l});var u=n.map(function(p){return q("%s = %j but expected %s",p.path,p.value,p.type)}).join(", "),c=new Error(q("%s (%s)",e,u));return c.details=n,c;function l(p,d,h){var y=[],_,m,v;for(_=0,m=p.length;_<m;_++)v=p[_],isNaN(v)?y.push("."+v):y.push("["+v+"]");n.push({path:s.name+y.join(""),value:d,type:h})}a(l,"errorHook")}a(Kt,"serializationError");function En(e){return e?O.getHash(e).readInt16BE(0)<<32-er:0}a(En,"normalizedPrefix");function Tn(e,t){return(e^t)>>32-er===0}a(Tn,"matchesPrefix");function Sn(e){return!!(e&&e.pipe)}a(Sn,"isStream");function kn(e,t){var r=e.message(t);if(!r)throw new Error(q("unknown message: %s",t));return r}a(kn,"getExistingMessage");function xn(e){var t=[e.wreq,e.wres],r=[],n;i(0);function i(s){var u=!1;s<e.fns.length?e.fns[s].apply(e.ctx,t.concat(function(c,l){if(u){e.onError(St("duplicate forward middleware call",c));return}if(u=!0,c||e.wres&&(e.wres.error!==void 0||e.wres.response!==void 0)){n=c,o();return}l&&r.push(l),i(++s)})):e.onTransition.apply(e.ctx,t.concat(function(c){if(u){e.onError(St("duplicate handler call",c));return}u=!0,n=c,process.nextTick(o)}))}a(i,"forward");function o(){var s=r.pop();if(s){var u=!1;s.call(e.ctx,n,function(c){if(u){e.onError(St("duplicate backward middleware call",c));return}n=c,u=!0,o()})}else e.onCompletion.call(e.ctx,n)}a(o,"backward")}a(xn,"chainMiddleware");An.exports={Adapter:Re,HANDSHAKE_REQUEST_TYPE:tt,HANDSHAKE_RESPONSE_TYPE:rt,Message:xe,Registry:nt,Service:E,discoverProtocol:No,streams:{FrameDecoder:Me,FrameEncoder:it,NettyDecoder:Ue,NettyEncoder:ot}}});var Rn=M((Tu,Cn)=>{"use strict";var Nt=require("fs"),On=require("path");function Co(){var e={};return function(t,r,n){if(t=On.resolve(t),e[t]){process.nextTick(n);return}e[t]=!0,Nt.readFile(t,{encoding:"utf8"},n)}}a(Co,"createImportHook");function Ro(){var e={};return function(t,r,n){t=On.resolve(t),e[t]?n():(e[t]=!0,n(null,Nt.readFileSync(t,{encoding:"utf8"})))}}a(Ro,"createSyncImportHook");Cn.exports={createImportHook:Co,createSyncImportHook:Ro,existsSync:Nt.existsSync,readFileSync:Nt.readFileSync}});var In=M((ku,Pn)=>{"use strict";var Ot=Rn(),Bn=qe(),sr=require("path"),Bo=require("util"),De=Bo.format,Po={date:{type:"int",logicalType:"date"},decimal:{type:"bytes",logicalType:"decimal"},time_ms:{type:"long",logicalType:"time-millis"},timestamp_ms:{type:"long",logicalType:"timestamp-millis"}};function ar(e,t,r){!r&&typeof t=="function"&&(r=t,t=void 0),t=t||{},t.importHook||(t.importHook=Ot.createImportHook());var n=[],i,o;t.importHook(e,"idl",function(c,l){if(c){r(c);return}if(l===void 0){r(null,{});return}try{var p=new I(l,t),d=p._readProtocol(l,t)}catch(h){h.path=e,r(h);return}i=d.protocol,o=d.imports,s()});function s(){var c=o.shift();if(!c)n.length&&(i.types=i.types?n.concat(i.types):n),r(null,i);else{var l=sr.join(sr.dirname(e),c.name);c.kind==="idl"?ar(l,t,u):t.importHook(l,c.kind,function(p,d){if(p){r(p);return}switch(c.kind){case"protocol":case"schema":if(d===void 0){u(null,{});return}try{var h=JSON.parse(d)}catch(_){_.path=l,r(_);return}var y=c.kind==="schema"?{types:[h]}:h;u(null,y);break;default:r(new Error(De("invalid import kind: %s",c.kind)))}})}}a(s,"fetchImports");function u(c,l){if(c){r(c);return}(l.types||[]).forEach(function(p){if(p.namespace===void 0){var d=l.namespace;if(!d){var h=/^(.*)\.[^.]+$/.exec(l.protocol);h&&(d=h[1])}p.namespace=d||""}n.push(p)});try{Object.keys(l.messages||{}).forEach(function(p){if(i.messages||(i.messages={}),i.messages[p])throw new Error(De("duplicate message: %s",p));i.messages[p]=l.messages[p]})}catch(p){r(p);return}s()}a(u,"mergeImportedSchema")}a(ar,"assembleProtocol");function Io(e){var t;if(typeof e=="string"&&~e.indexOf(sr.sep)&&Ot.existsSync(e)){var r=Ot.readFileSync(e,{encoding:"utf8"});try{return JSON.parse(r)}catch{var n={importHook:Ot.createSyncImportHook()};ar(e,n,function(o,s){t=o?r:s})}}else t=e;if(typeof t!="string"||t==="null")return t;try{return JSON.parse(t)}catch{try{return I.readProtocol(t)}catch{try{return I.readSchema(t)}catch{return t}}}}a(Io,"read");function I(e,t){t=t||{},this._tk=new Be(e),this._ackVoidMessages=!!t.ackVoidMessages,this._implicitTags=!t.delimitedCollections,this._typeRefs=t.typeRefs||Po}a(I,"Reader");I.readProtocol=function(e,t){var r=new I(e,t),n=r._readProtocol();if(n.imports.length)throw new Error("unresolvable import");return n.protocol};I.readSchema=function(e,t){var r=new I(e,t),n=r._readJavadoc(),i=r._readType(n===void 0?{}:{doc:n});return r._tk.next({id:"(eof)"}),i};I.prototype._readProtocol=function(){var e=this._tk,t=[],r=[],n={},i;this._readImports(t);var o={},s=this._readJavadoc();for(s!==void 0&&(o.doc=s),this._readAnnotations(o),e.next({val:"protocol"}),e.next({val:"{",silent:!0})||(o.protocol=e.next({id:"name"}).val,e.next({val:"{"}));!e.next({val:"}",silent:!0});)if(!this._readImports(t)){var u=this._readJavadoc(),c=this._readType(),l=this._readImports(t,!0),p=void 0;if(i=e.pos,!l&&(p=this._readMessage(c))){u!==void 0&&p.schema.doc===void 0&&(p.schema.doc=u);var d=!1;if((p.schema.response==="void"||p.schema.response.type==="void")&&(d=!this._ackVoidMessages&&!p.schema.errors,p.schema.response==="void"?p.schema.response="null":p.schema.response.type="null"),d&&(p.schema["one-way"]=!0),n[p.name])throw new Error(De("duplicate message: %s",p.name));n[p.name]=p.schema}else u&&(typeof c=="string"?c={doc:u,type:c}:c.doc===void 0&&(c.doc=u)),r.push(c),e.pos=i,e.next({val:";",silent:!0});u=void 0}return e.next({id:"(eof)"}),r.length&&(o.types=r),Object.keys(n).length&&(o.messages=n),{protocol:o,imports:t}};I.prototype._readAnnotations=function(e){for(var t=this._tk;t.next({val:"@",silent:!0});){for(var r=[];!t.next({val:"(",silent:!0});)r.push(t.next().val);e[r.join("")]=t.next({id:"json"}).val,t.next({val:")"})}};I.prototype._readMessage=function(e){var t=this._tk,r={request:[],response:e};this._readAnnotations(r);var n=t.next().val;if(t.next().val==="("){if(!t.next({val:")",silent:!0}))do r.request.push(this._readField());while(!t.next({val:")",silent:!0})&&t.next({val:","}));var i=t.next();switch(i.val){case"throws":r.errors=[];do r.errors.push(this._readType());while(!t.next({val:";",silent:!0})&&t.next({val:","}));break;case"oneway":r["one-way"]=!0,t.next({val:";"});break;case";":break;default:throw t.error("invalid message suffix",i)}return{name:n,schema:r}}};I.prototype._readJavadoc=function(){var e=this._tk.next({id:"javadoc",emitJavadoc:!0,silent:!0});if(e)return e.val};I.prototype._readField=function(){var e=this._tk,t=this._readJavadoc(),r={type:this._readType()};return t!==void 0&&r.doc===void 0&&(r.doc=t),this._readAnnotations(r),r.name=e.next({id:"name"}).val,e.next({val:"=",silent:!0})&&(r.default=e.next({id:"json"}).val),r};I.prototype._readType=function(e){switch(e=e||{},this._readAnnotations(e),e.type=this._tk.next({id:"name"}).val,e.type){case"record":case"error":return this._readRecord(e);case"fixed":return this._readFixed(e);case"enum":return this._readEnum(e);case"map":return this._readMap(e);case"array":return this._readArray(e);case"union":if(Object.keys(e).length>1)throw new Error("union annotations are not supported");return this._readUnion();default:var t=this._typeRefs[e.type];return t&&(delete e.type,Bn.copyOwnProperties(t,e)),Object.keys(e).length>1?e:e.type}};I.prototype._readFixed=function(e){var t=this._tk;return t.next({val:"(",silent:!0})||(e.name=t.next({id:"name"}).val,t.next({val:"("})),e.size=parseInt(t.next({id:"number"}).val),t.next({val:")"}),e};I.prototype._readMap=function(e){var t=this._tk,r=this._implicitTags,n=t.next({val:"<",silent:r})===void 0;return e.values=this._readType(),t.next({val:">",silent:n}),e};I.prototype._readArray=function(e){var t=this._tk,r=this._implicitTags,n=t.next({val:"<",silent:r})===void 0;return e.items=this._readType(),t.next({val:">",silent:n}),e};I.prototype._readEnum=function(e){var t=this._tk;t.next({val:"{",silent:!0})||(e.name=t.next({id:"name"}).val,t.next({val:"{"})),e.symbols=[];do e.symbols.push(t.next().val);while(!t.next({val:"}",silent:!0})&&t.next({val:","}));return e};I.prototype._readUnion=function(){var e=this._tk,t=[];e.next({val:"{"});do t.push(this._readType());while(!e.next({val:"}",silent:!0})&&e.next({val:","}));return t};I.prototype._readRecord=function(e){var t=this._tk;for(t.next({val:"{",silent:!0})||(e.name=t.next({id:"name"}).val,t.next({val:"{"})),e.fields=[];!t.next({val:"}",silent:!0});)e.fields.push(this._readField()),t.next({val:";"});return e};I.prototype._readImports=function(e,t){for(var r=this._tk,n=0,i=r.pos;r.next({val:"import",silent:!0});){if(!n&&t&&r.next({val:"(",silent:!0})){r.pos=i;return}var o=r.next({id:"name"}).val,s=JSON.parse(r.next({id:"string"}).val);r.next({val:";"}),e.push({kind:o,name:s}),n++}return n};function Be(e){this._str=e,this.pos=0}a(Be,"Tokenizer");Be.prototype.next=function(e){var t={pos:this.pos,id:void 0,val:void 0},r=this._skip(e&&e.emitJavadoc);if(r)t.id="javadoc",t.val=r;else{var n=this.pos,i=this._str,o=i.charAt(n);if(!o)t.id="(eof)";else if(e&&e.id==="json"?(t.id="json",this.pos=this._endOfJson()):o==='"'?(t.id="string",this.pos=this._endOfString()):/[0-9]/.test(o)?(t.id="number",this.pos=this._endOf(/[0-9]/)):/[`A-Za-z_.]/.test(o)?(t.id="name",this.pos=this._endOf(/[`A-Za-z0-9_.]/)):(t.id="operator",this.pos=n+1),t.val=i.slice(n,this.pos),t.id==="json")try{t.val=JSON.parse(t.val)}catch{throw this.error("invalid JSON",t)}else t.id==="name"&&(t.val=t.val.replace(/`/g,""))}var s;if(e&&e.id&&e.id!==t.id?s=this.error(De("expected ID %s",e.id),t):e&&e.val&&e.val!==t.val&&(s=this.error(De("expected value %s",e.val),t)),s)if(e&&e.silent){this.pos=t.pos;return}else throw s;else return t};Be.prototype.error=function(e,t){var r=typeof t!="number",n=r?t.pos:t,i=this._str,o=1,s=0,u;for(u=0;u<n;u++)i.charAt(u)===`
`&&(o++,s=u);var c=r?De("invalid token %j: %s",t,e):e,l=new Error(c);return l.token=r?t:void 0,l.lineNum=o,l.colNum=n-s,l};Be.prototype._skip=function(e){for(var t=this._str,r=!1,n,i;(i=t.charAt(this.pos))&&/\s/.test(i);)this.pos++;if(n=this.pos,i==="/")switch(t.charAt(this.pos+1)){case"/":for(this.pos+=2;(i=t.charAt(this.pos))&&i!==`
`;)this.pos++;return this._skip(e);case"*":for(this.pos+=2,t.charAt(this.pos)==="*"&&(r=!0);i=t.charAt(this.pos++);)if(i==="*"&&t.charAt(this.pos)==="/")return this.pos++,r&&e?jo(t.slice(n+3,this.pos-2)):this._skip(e);throw this.error("unterminated comment",n)}};Be.prototype._endOf=function(e){for(var t=this.pos,r=this._str;e.test(r.charAt(t));)t++;return t};Be.prototype._endOfString=function(){for(var e=this.pos+1,t=this._str,r;r=t.charAt(e);){if(r==='"')return e+1;r==="\\"?e+=2:e++}throw this.error("unterminated string",e-1)};Be.prototype._endOfJson=function(){var e=Bn.jsonEnd(this._str,this.pos);if(e<0)throw this.error("invalid JSON",e);return e};function jo(e){for(var t=e.replace(/^[ \t]+|[ \t]+$/g,"").split(`
`).map(function(r,n){return n?r.replace(/^\s*\*\s?/,""):r});!t[0];)t.shift();for(;!t[t.length-1];)t.pop();return t.join(`
`)}a(jo,"extractJavadoc");Pn.exports={Tokenizer:Be,assembleProtocol:ar,read:Io,readProtocol:I.readProtocol,readSchema:I.readSchema}});var Mn=M((Au,jn)=>{"use strict";var at=yn(),Ct=Nn(),st=In(),ze=gt(),ur=qe(),$e=require("fs"),cr=require("util");function Mo(e,t){var r=st.read(e);return r.protocol?Ct.Service.forProtocol(r,t):ze.Type.forSchema(r,t)}a(Mo,"parse");function Fo(e,t){t=t||{};for(var r=t.decode===void 0?!0:!!t.decode,n=Math.max(t.size||4096,4),i=$e.openSync(e,"r"),o=ur.newBuffer(n),s=0,u=new ur.Tap(o),c=null;s<4;)s+=$e.readSync(i,o,s,n-s);if(at.MAGIC_BYTES.equals(o.slice(0,4))){do c=at.HEADER_TYPE._read(u);while(!p());if(r!==!1){var l=c.meta;l["avro.schema"]=JSON.parse(l["avro.schema"].toString()),l["avro.codec"]!==void 0&&(l["avro.codec"]=l["avro.codec"].toString())}}return $e.closeSync(i),c;function p(){if(u.isValid())return!0;var d=2*u.buf.length,h=ur.newBuffer(d);return d=$e.readSync(i,h,0,d),u.buf=Buffer.concat([u.buf,h]),u.pos=0,!1}a(p,"isValid")}a(Fo,"extractFileHeader");function Lo(e,t){return $e.createReadStream(e).pipe(new at.streams.BlockDecoder(t))}a(Lo,"createFileDecoder");function qo(e,t,r){var n=new at.streams.BlockEncoder(t,r);return n.pipe($e.createWriteStream(e,{defaultEncoding:"binary"})),n}a(qo,"createFileEncoder");jn.exports={Service:Ct.Service,Type:ze.Type,assembleProtocol:st.assembleProtocol,createFileDecoder:Lo,createFileEncoder:qo,discoverProtocol:Ct.discoverProtocol,extractFileHeader:Fo,parse:Mo,readProtocol:st.readProtocol,readSchema:st.readSchema,streams:at.streams,types:ze.builtins,Protocol:Ct.Service,assemble:cr.deprecate(st.assembleProtocol,"use `assembleProtocol` instead"),combine:cr.deprecate(ze.Type.forTypes,"use `Type.forTypes` intead"),infer:cr.deprecate(ze.Type.forValue,"use `Type.forValue` instead"),errorsCollector:ze.errorsCollector}});var qn=M((Ou,Ln)=>{"use strict";var{dependencies:Ho}=ee(),Ge=Mn(),{parseJson:Rt}=Ee(),{SCRIPT_TYPES:Ye}=we(),Vo=/\/.+\/.+\/.+\/schema/,Uo=/.+\/.+\/.*\/schema/,Do=/.+\/.*\/.+\/schema/,zo="Pulsar namespace is missing",$o="Pulsar topic is missing",Go="Schema Group is missing",Fn="Avro schema is valid",Yo="Avro schemas are valid",Fe,Jo=a((e,t,r)=>{Fe=Ho.lodash,t=Wo(e)||t;let n=Ko(e,t),i=es(t),o=n.map(s=>i(s,r));return n.length===1?Fe.first(o):os(Fe.flatten(o))},"validateAvroScript"),Wo=a(e=>{if(Rt(e).type)return Ye.COMMON},"detectScriptType"),Ko=a((e,t)=>{switch(t){case Ye.CONFLUENT_SCHEMA_REGISTRY:return Zo(e);case Ye.AZURE_SCHEMA_REGISTRY:return Qo(e);case Ye.PULSAR_SCHEMA_REGISTRY:return Xo(e);default:return[{script:e}]}},"parseScript"),Zo=a(e=>[...e.matchAll(/^POST \/(.*)$\n(^\{[\s\S]*?^\})/gm)].map(([r,n,i])=>{let{schema:o}=Rt(i);return Fe.isPlainObject(o)?{script:JSON.stringify(o)}:{script:o}}),"parseConfluentScript"),Qo=a(e=>{let t=[...e.matchAll(/^PUT \/(.*)$\n(^\{[\s\S]*?^\})/gm)];return(Fe.isEmpty(t)?[...e.matchAll(/^PUT \/(.*)\n(\{[\s\S]*?}$)/gm)]:t).map(([n,i,o])=>({script:o,query:i}))},"parseAzureScript"),Xo=a(e=>{let t=[...e.matchAll(/^POST \/(.*)$\n(^\{[\s\S]*?^\})/gm)];return(Fe.isEmpty(t)?[...e.matchAll(/^POST \/(.*)\n(\{[\s\S]*?}$)/gm)]:t).map(([n,i,o])=>({script:o,query:i}))},"parsePulsarScript"),es=a(e=>e===Ye.AZURE_SCHEMA_REGISTRY?ts:e===Ye.PULSAR_SCHEMA_REGISTRY?rs:ns,"getScriptValidator"),ts=a(({script:e,query:t},r)=>{if(/.+\/schemas/.test(t))return lr(e,r);let{namespace:i}=Rt(e);return[Je(i)({message:Go})]},"validateAzureScript"),rs=a(({script:e,query:t},r)=>{if(Vo.test(t))return lr(e,r);let i=Uo.test(t),o=Do.test(t);return i&&o?[pr(Fn)]:[!i&&Je()({message:zo}),!o&&Je()({message:$o})].filter(Boolean)},"validatePulsarScript"),ns=a(({script:e},t)=>lr(e,t),"validateScriptGeneral"),lr=a((e,t)=>{try{return is(e)}catch(r){return t.log("error",{error:r},"Avro Validation Error"),[Je()(r)]}},"validateScript"),is=a(e=>{let t=Rt(e).name;try{if(fr(),Ge.parse(e),Fe.isEmpty(Ge.errorsCollector))return[pr(Fn)];let r=Ge.errorsCollector.map(Je(t));return fr(),r}catch(r){let i=(r instanceof TypeError?Ge.errorsCollector:Ge.errorsCollector.concat(r)).map(Je(t));return fr(),i}},"validate"),os=a(e=>{let t=a(n=>(n==null?void 0:n.type)!=="success","isErrorMessage");return e.some(t)?e.filter(t):[pr(Yo)]},"getMessageForMultipleSchemaValidation"),fr=a(()=>{Ge.errorsCollector.splice(0)},"clearErrorsCollector"),Je=a((e="")=>t=>({label:t.fieldName||e||t.name||"",title:t.message,type:"error",context:""}),"getErrorMessage"),pr=a(e=>({type:"success",label:"",title:e,context:""}),"getSuccessMessage");Ln.exports=Jo});var hr=M((Ru,Vn)=>{"use strict";var{dependencies:ss}=ee(),{SCRIPT_TYPES:dr}=we(),{reorderAttributes:as}=Ee(),Bt,us=a(({scriptType:e,settings:t,needMinify:r,isJsonFormat:n,avroSchema:i})=>(Bt=ss.lodash,cs(e)({settings:t,needMinify:r,isJsonFormat:n,avroSchema:Bt.isArray(i)?i:as({...i,name:t.name,namespace:t.namespace||i.namespace})})),"formatAvroSchemaByType"),cs=a(e=>{switch(e){case dr.CONFLUENT_SCHEMA_REGISTRY:return fs;case dr.AZURE_SCHEMA_REGISTRY:return ps;case dr.PULSAR_SCHEMA_REGISTRY:return ds;default:return hs}},"getFormatter"),fs=a(({settings:e,needMinify:t,isJsonFormat:r,avroSchema:n})=>{let{name:i,namespace:o,confluentSubjectName:s,schemaType:u,schemaTopic:c,schemaNameStrategy:l,schemaRegistryUrl:p,confluentCompatibility:d,references:h}=e;return ls({schema:n,isJsonFormat:r,needMinify:t,name:i,namespace:o,confluentSubjectName:s,schemaType:u,schemaTopic:c,schemaNameStrategy:l,schemaRegistryUrl:p,confluentCompatibility:d,references:h})},"formatConfluentSchema"),Hn=a(({name:e,namespace:t,schemaType:r,schemaTopic:n,schemaNameStrategy:i,confluentSubjectName:o})=>{let s="RecordNameStrategy",u="TopicNameStrategy",c="TopicRecordNameStrategy";if(!i&&o)return o;let l=[t,e].filter(Boolean).join("."),p=r||"",d=n||"";switch(i){case s:return[l,p].filter(Boolean).join("-");case u:return[d||e,p].filter(Boolean).join("-");case c:return[d,l,p].filter(Boolean).join("-");default:return[e,p].filter(Boolean).join("-")}},"getConfluentSubjectName"),ls=a(({name:e,namespace:t,schemaType:r,schemaTopic:n,schemaNameStrategy:i,confluentSubjectName:o,confluentCompatibility:s,needMinify:u,isJsonFormat:c,references:l,schema:p})=>{let d=Hn({name:e,namespace:t,schemaType:r,schemaTopic:n,schemaNameStrategy:i,confluentSubjectName:o}),h=s?`PUT /config/${d} HTTP/1.1
{ "compatibility": "${s}" }

`:"",y={schema:p,schemaType:"AVRO",...!Bt.isEmpty(l)&&{references:Bt.uniqBy(l,"name")}};return c?Pt(u,{...y,schema:JSON.stringify(p)}):`${h}POST /subjects/${d}/versions
${Pt(u,y)}`},"getConfluentPostQuery"),ps=a(({settings:e,needMinify:t,isJsonFormat:r,avroSchema:n})=>{let{schemaGroupName:i,name:o}=e,s=Pt(t,n);return r?s:`PUT /${i}/schemas/${o}?api-version=2020-09-01-preview
${s}`},"formatAzureSchemaRegistry"),ds=a(({settings:e,needMinify:t,isJsonFormat:r,avroSchema:n})=>{let{persistence:i,namespace:o,topic:s}=e,c=Pt(t,{type:"AVRO",data:n,properties:{}});return r?c:`POST /${i}/${o}/${s}/schema
${c}`},"formatPulsarSchemaRegistry"),hs=a(({needMinify:e,avroSchema:t})=>JSON.stringify(t,null,e?0:4),"formatCommon"),Pt=a((e,t)=>e?JSON.stringify(t):JSON.stringify(t,null,4),"stringifyCommon");Vn.exports={formatAvroSchemaByType:us,getConfluentSubjectName:Hn}});var $n=M((Pu,zn)=>{"use strict";var{dependencies:ys}=ee(),It,_s=["properties","definitions","patternProperties"],ms=["items","oneOf","allOf","anyOf","not"],Dn=a((e,t=[])=>r=>{if(It=ys.lodash,!It.isPlainObject(r))return r;let n=[...t,r.GUID],i=Dn(e,n),o=Un(_s,{...r},vs(i)),s=Un(ms,o,gs(i));return e(s,n)},"mapJsonSchema"),vs=a(e=>t=>Object.keys(t).reduce((r,n)=>({...r,[n]:e(t[n])}),{}),"mapProperties"),gs=a(e=>t=>It.isArray(t)?t.map(e):It.isPlainObject(t)?e(t):t,"mapItems"),Un=a((e,t,r)=>e.reduce((n,i)=>n[i]?{...n,[i]:r(n[i])}:n,t),"applyTo");zn.exports=Dn});var Yn=M((ju,Gn)=>{"use strict";var ut=a((e,t)=>{if(Array.isArray(e))return e.map(r=>ut(r,t));if(e=t(e),typeof e=="string")return e;if(Array.isArray(e.fields)){let r=e.fields.map(n=>{let i=ut(n.type,t);return Array.isArray(i.type)?{...n,...i}:{...n,type:i}});e={...e,fields:r}}return e.values&&(e={...e,values:ut(e.values,t)}),e.items&&(e={...e,items:ut(e.items,t)}),e},"mapAvroSchema");Gn.exports=ut});var gr=M((Lu,ti)=>{"use strict";var{dependencies:We}=ee(),{isNamedType:_r,filterAttributes:bs}=dt(),{AVRO_TYPES:ws,SCRIPT_TYPES:Fu}=we(),Wn=$n(),{reorderAttributes:mr,simplifySchema:Es}=Ee(),Kn=Yn(),{getConfluentSubjectName:Ts}=hr(),{prepareName:Zn}=Ee(),A,fe={},ct=a(e=>{if(A=We.lodash,!A.isString(e))return;let t=A.last(e.split("."));return A.clone(fe[t])},"getUdtItem"),Ss=a(e=>(A=We.lodash,Kn(e,vr)),"resolveUdt"),ks=a(e=>{fe[e]&&(fe[e].used=!0)},"useUdt"),xs=a(e=>A.isString(e)?{type:e}:{...e},"prepareTypeFromUDT"),Qn=a(e=>{let t=ct(e);return!t||t.used||t.isCollectionReference},"isUdtUsed"),As=a(e=>A.isString(e)?_r(e):_r(e==null?void 0:e.type),"isDefinitionTypeValidForAvroDefinition"),vr=a(e=>{let t=A.isString(e)||A.isArray(e)?e:e.type;if(Ns(t))return e;if(A.isString(e))return Jn(e);if(A.isArray(t))return{...A.isArray(e)?{}:e,type:t.map(vr)};let r=Jn(t);return A.isArray(A.get(r,"type"))?mr({...e,...r,...e.name&&{name:e.name},...e.doc&&{doc:e.doc}}):mr({...e,...xs(r),...e.name&&{name:e.name},...e.doc&&{doc:e.doc}})},"resolveSchemaUdt"),Ns=a(e=>!ct(e)&&A.includes(ws,e),"isNativeType"),Jn=a(e=>{if(Qn(e))return Cs(e);let{schema:t}=ct(e)||{},r=Os(t);return As(r)?ks(e):r=Kn(r,Rs),A.isString(r.type)?r:vr(r)},"getTypeFromUdt"),Os=a(e=>e.type!=="enum"?e:{...A.omit(e,"symbolDefault"),default:e.default??e.symbolDefault},"resolveSymbolDefaultValue"),Cs=a(e=>{let t=ct(e);return!t||!t.schema.namespace?e:t.schema.namespace+"."+e},"getTypeWithNamespace"),Rs=a(e=>_r(e.type)?((!fe[e.name]||!Qn(e.name))&&(fe[e.name]={schema:e}),Es(Xn(e))):e,"convertNamedTypesToReferences"),Xn=a(e=>{A=We.lodash;let t=bs(A.omit(e,"type"));return mr({...t,type:e.name})},"convertSchemaToReference"),ei=a(e=>{fe={...fe,...e}},"addDefinitions"),Bs=a(()=>{fe={}},"clearDefinitions"),Ps=a(()=>{A=We.lodash,fe=Object.keys(fe||{}).reduce((e,t)=>{let r=fe[t];return{...e,[t]:A.isString(r)?r:A.omit(r,"used")}},{})},"resetDefinitionsUsage"),Is=a((e,t)=>{A=We.lodash;let r=e.map(i=>i.jsonSchema.GUID),n=e.map(i=>{let o=[],u=Wn((c,l)=>{if(!c.ref)return c;let p=!!c.parentCollectionName,d;if(r.includes(c.ref))d=e.find(m=>m.jsonSchema.GUID===c.ref).jsonSchema;else{if(!p)return c;d=c.parentCollection||{}}let h=Zn(d.code||d.collectionName||d.name||c.parentCollectionName),y=d.bucketName||c.parentBucketName,_=Ts({name:h,namespace:y,schemaType:d.schemaType,schemaTopic:d.schemaTopic,schemaNameStrategy:d.schemaNameStrategy,confluentSubjectName:d.confluentSubjectName});return o=[...o,{name:h,namespace:y,subject:_,path:l,version:Ls(d.confluentVersion)}],{...c,$ref:`#/definitions/${h}`,namespace:c.namespace||c.parentBucketName,default:c.nullable?null:c.default}})(i.jsonSchema);return ei(o.reduce((c,l)=>({...c,[l.name]:{isCollectionReference:!0,schema:{},originalSchema:{}}}),{})),{...i,jsonSchema:u,references:js(i,o).map(c=>A.omit({...c,name:[c.namespace,c.name].filter(Boolean).join(".")},["path","namespace"]))}});return Fs(n)},"convertCollectionReferences"),js=a((e,t)=>t.filter(r=>{var o;return A.last(r.path)===((o=e==null?void 0:e.jsonSchema)==null?void 0:o.GUID)?!1:!t.find(s=>{var u;return!s.path||s.path.length>=((u=r.path)==null?void 0:u.length)?!1:s.path.every((c,l)=>{var p;return c===((p=r.path)==null?void 0:p[l])})})}),"filterReferencesByPath"),Ms=a(e=>(A=We.lodash,e.map(r=>{let i=Wn(o=>!o.ref||!!!o.parentCollectionName?o:A.omit(o,"$ref"))(r.jsonSchema);return{...r,jsonSchema:i}})),"resolveNamespaceReferences"),Fs=a(e=>{let[t,r]=A.partition(e,s=>{let u=(s.references||[]).map(c=>c.name);return!A.isEmpty(u)}),n=e.map(yr),i=r,o=i.map(yr);for(;t.length>1;)for(let s in t){let u=t[s];(t[s].references||[]).map(l=>l.name).filter(l=>n.includes(l)).every(l=>o.includes(l))&&(i.push(u),o.push(yr(t[s])),t.splice(s,1))}return i.length!==e.length?[...i,...e.filter(s=>!i.includes(s))]:i},"topologicalSort"),yr=a(e=>{var t,r,n;return Zn(((t=e.entityData)==null?void 0:t.code)||((r=e.entityData)==null?void 0:r.name)||((n=e.entityData)==null?void 0:n.collectionName))},"getSchemaNameFromEntity"),Ls=a(e=>e?isNaN(e)?e:Number(e):1,"getConfluentSchemaVersion");ti.exports={resolveUdt:Ss,getUdtItem:ct,addDefinitions:ei,clearDefinitions:Bs,convertSchemaToReference:Xn,resetDefinitionsUsage:Ps,convertCollectionReferences:Is,resolveNamespaceReferences:Ms}});var br=M((Hu,ni)=>{"use strict";var{dependencies:ri}=ee(),{prepareName:qs}=Ee(),Hs=a(e=>{if(e.$ref){if(ri.lodash.includes(e.$ref,"#")){let t=e.namespace||"",r=qs(ri.lodash.last(e.$ref.split("/"))||"");return[t,r].filter(Boolean).join(".")}return e.$ref}},"getTypeFromReference");ni.exports=Hs});var li=M((Uu,fi)=>{"use strict";var{dependencies:Vs}=ee(),{filterMultipleTypes:Us,prepareName:wr,getDefaultName:Ds,convertName:ii}=Ee(),oi=br(),{AVRO_TYPES:zs}=we(),le,ai=["oneOf","anyOf","allOf"],ui=a(e=>(le=Vs.lodash,ai.reduce((t,r)=>ci(t,r),e)),"convertChoicesToProperties"),$s=a(e=>e.$ref,"subSchemaIsEntityReference"),ci=a((e,t)=>{if(!e[t])return e;let r=e[Er(t)]||{};if(le.isArray(r))return Gs(e,r);let n=e[t].map(ui).flatMap(o=>$s(o)?[{...o,type:oi(o)}]:o.type==="array"?o.items:Object.keys(o.properties||{}).map(s=>({name:wr(s),...o.properties[s]}))).filter(o=>!le.isEmpty(o));if(e.type==="array")return{...e,items:[...(e.items||[]).filter(o=>!le.isEmpty(o)),...n]};let i=n.reduce((o,s,u)=>{let c=r.code||r.name||s.name||Ds(),l=o[c]||{...r,default:Js(s.type,r.default),name:wr(c),type:[],choiceMeta:r},p={...s,type:s.$ref?oi(s):s.type,name:wr(s.name||c)},d=Us(Ws(l.type).concat(p)),h=le.isArray(d)?d.map(m=>(m==null?void 0:m.type)||m):(d==null?void 0:d.type)||d,y=u===0?p.default:void 0,_=le.isUndefined(l.default)?y:l.default;return{...o,[c]:{...ii(l),...ii(p),default:_,type:h}}},{});return{...e,properties:Ks(e.properties,i)}},"convertChoiceToProperties"),Gs=a((e,t)=>{let n=t.reduce((i,o)=>{let s=e.allOf.filter(l=>((o==null?void 0:o.ids)||[]).includes(l.GUID)),u=o==null?void 0:o.choice;if(!u||u==="allOf")return[...i,{items:s,type:"allOf",meta:o}];let c=le.first(s)[u];return[...i,{items:c,type:u,meta:o}]},[]).reduce((i,o)=>{let s=o.type,u={...Ys(i),[s]:o.items,[Er(s)]:o.meta};return ci(u,s)},e);return{...e,...n}},"handleMergedChoice"),Er=a(e=>`${e}_meta`,"getChoiceMetaKeyword"),Ys=a(e=>le.omit(e,ai.flatMap(t=>[t,Er(t)])),"removeChoices"),Js=a((e,t)=>e==="null"&&t==="null"?null:e==="number"&&!isNaN(t)?Number(t):t,"convertDefaultMetaFieldType"),Ws=a((e=[])=>le.isArray(e)?e:[e],"ensureArray"),si=a(e=>le.get(e,"choiceMeta.index"),"getChoiceIndex"),Ks=a((e,t)=>{if(le.isEmpty(t))return e||{};let r=Object.values(t).flatMap(({type:i})=>i).filter(i=>!zs.includes(i)),n=Object.entries(e||{}).filter(([i,o])=>!r.includes(i)).map(([i,o],s)=>[i,{...o,choiceMeta:{index:s}}]);return Object.fromEntries([...Object.entries(t),...n].sort(([i,o],[s,u])=>si(o)-si(u)))},"addPropertiesFromChoices");fi.exports=ui});var kr=M((zu,di)=>{"use strict";var{AVRO_TYPES:Zs}=we(),{dependencies:Qs}=ee(),Mt={},jt={},Xs=a((e,t)=>{jt=t,Mt=e||{};let r=ea();Object.keys(r).length&&(jt==null||jt.log("info",`Plugin custom properties:
${JSON.stringify(r,null,4)}`,"Custom Properties detected"))},"initPluginConfiguration"),ea=a(()=>{let e=Tr(pi());return Zs.reduce((t,r)=>{let n=Tr(Sr(r));return n.length?{...t,[r]:n}:t},{...e.length&&{entity:e}})},"getCustomPropertiesConfigMap"),Tr=a(e=>e.filter(t=>t.includeInScript),"getCustomPropertiesConfig"),ta=a((e,t)=>e.filter(r=>!r.dependency||!(r.dependency.key&&r.dependency.value)?!0:t[r.dependency.key]===r.dependency.value),"filterConfigByDependency"),ra=a((e,t={})=>ta(Tr(e),t).map(r=>r.fieldKeyword),"getCustomPropertiesKeywords"),na=a((e,t={})=>Qs.lodash.pick(t,ra(e,t)),"getCustomProperties"),Sr=a(e=>{var r,n,i,o;if(Array.isArray(e))return e.flatMap(Sr);let t=((n=(r=Mt.fieldLevelConfig)==null?void 0:r.tabs)==null?void 0:n.filter(s=>s.customTab).flatMap(s=>{var u;return((u=s.structure)==null?void 0:u[e])||[]}))||[];return[...((o=(i=Mt.fieldLevelConfig)==null?void 0:i.structure)==null?void 0:o[e])||[],...t]},"getFieldLevelConfig"),pi=a(()=>{var e;return((e=Mt.entityLevelConfig)==null?void 0:e.flatMap(t=>(t==null?void 0:t.structure)||[]))||[]},"getEntityLevelConfig");di.exports={initPluginConfiguration:Xs,getCustomProperties:na,getFieldLevelConfig:Sr,getEntityLevelConfig:pi}});var wi=M((Gu,bi)=>{"use strict";var{dependencies:ia}=ee(),{filterAttributes:oa,isNamedType:Ar}=dt(),{getUdtItem:Or,convertSchemaToReference:sa,addDefinitions:aa}=gr(),{reorderAttributes:yi,filterMultipleTypes:ua,prepareName:ca,simplifySchema:Nr,getDefaultName:Cr,convertName:fa,compareSchemasByStructure:la}=Ee(),pa=li(),{GENERAL_ATTRIBUTES:xr,META_VALUES_KEY_MAP:da}=we(),{getFieldLevelConfig:_i,getCustomProperties:mi}=kr(),vi=br(),Rr="string",S,Le=a(e=>(S=ia.lodash,ya(e)?_a(e):(e=ha(e),e=va(e),e=ga(e),e=ba(e),e=wa(e),e=Ea(e),e=Ta(e),e=fa(e),e=Sa(e),e=ka(e),e=Br(e),e=yi(e),e=Nr(e),e)),"convertSchema"),ha=a(e=>{let t={...pa(e),type:!e.type||e.$ref&&!e.choice?vi(e):ma(e.type)};return t.nullable?{...S.omit(t,["nullable","$ref"]),default:null,type:["null",t.type]}:S.omit(t,"nullable")},"prepareSchema"),ya=a(e=>{var t;return!((t=e==null?void 0:e.oneOf)!=null&&t.length)||Object.values((e==null?void 0:e.properties)??{}).length?!1:e.oneOf.every(r=>r.$ref||r.ref)},"isBareUnionSchema"),_a=a(e=>e.oneOf.map(({confluentSubjectName:t,parentBucketName:r,name:n})=>t??`${r||e.bucketName}.${n}`),"convertBareUnionSchema"),ma=a(e=>e==="object"?"record":e,"getAvroType"),va=a(e=>{let t=e.description;return t?{...e,doc:t}:e},"convertDescriptionToDoc"),ga=a(e=>{let t=Ha(e);return S.isUndefined(t)?e:{...e,default:t}},"convertDefault"),ba=a(e=>{let t=e.logicalType||e.subtype;return t?{...e,logicalType:t}:e},"convertLogicalType"),wa=a(e=>e.durationSize&&e.logicalType==="duration"?{...e,size:e.durationSize}:e,"convertSize"),Ea=a(e=>!S.isArray(e.required)||!e.properties?e:{...e,properties:Object.keys(e.properties).reduce((t,r)=>{let n=e.properties[r];return!e.required.includes(r)||n.nullable?{...t,[r]:n}:{...t,[r]:{...S.omit(n,"default"),required:!0}}},{})},"handleRequired"),Ta=a(e=>{if(!e.properties)return e;let t=e.type==="map"?"values":"fields";return{...e,[t]:e.properties}},"convertProperties"),Sa=a(e=>S.isArray(e.type)||e.type==="null"?e:{...e,...Va(e.metaProps||[])},"convertMetaProperties"),ka=a(e=>{if(S.isArray(e.type))return xa(e);switch(e.type){case"string":case"boolean":case"null":return Ma(e);case"number":return La(e);case"bytes":return Aa(e);case"map":return Na(e);case"array":return Ra(e);case"fixed":return Ca(e);case"enum":return Fa(e);case"record":return ja(e);default:return e}},"convertType"),Br=a(e=>oa(e,e.type),"filterSchemaAttributes"),xa=a(e=>{let t=ua(e.type.map(n=>{if(S.isString(n)){let s=Le({...e,type:n});if(S.isString(s))return s;let u=s.type==="enum"?S.without(xr,"default"):xr;return Nr({...S.omit(s,u),type:s.type})}let i=n.type||vi(n)||Rr,o=S.omit({...e,...n},xr);return Le({...o,type:i})})),r=Br(S.omit(e,"type"));return r=yi(r),r=Nr(r),{...r,type:t}},"convertMultiple"),Aa=a(e=>({...e,...gi(e)}),"convertBytes"),gi=a(e=>{let t=e.logicalType;if(!t)return{};switch(t){case"decimal":return{logicalType:t,...e.precision&&{precision:e.precision},...e.scale&&{scale:e.scale}};default:return{logicalType:t}}},"getLogicalTypeProperties"),Na=a(e=>({...e,values:e.values?Oa(e.values):Rr}),"convertMap"),Oa=a(e=>{let t=S.first(Object.keys(e));return Le((e==null?void 0:e[t])||{})},"getValuesSchema"),Ca=a(e=>Pr({...e,name:e.name||Cr(),size:S.isUndefined(e.size)?16:e.size,...gi(e)}),"convertFixed"),Ra=a(e=>{if(S.isArray(e.items)){let t=qa(e.items.map(r=>Le(r)));return t.length===1?{...e,items:S.first(t)}:{...e,items:t}}return{...e,items:Le(e.items||{type:Rr})}},"convertArray"),Ba=a((e,t)=>{let{description:r,refDescription:n,default:i,order:o,aliases:s,...u}=t,c=Le(u),l=Or(c),p=(l==null?void 0:l.customProperties)||mi(_i(u.type),u);return Ia({name:ca(e),type:S.isArray(c.type)?c.type:c,default:Pa(t,l,c),doc:t.$ref?n:r,order:o,aliases:s,...p},c)},"handleField"),Pa=a((e,t,r)=>{var n,i;return!S.isUndefined(e==null?void 0:e.default)||(r==null?void 0:r.type)==="enum"?e==null?void 0:e.default:e!=null&&e.$ref&&!(e!=null&&e.required)&&((n=t==null?void 0:t.originalSchema)==null?void 0:n.type)==="enum"?(i=t==null?void 0:t.originalSchema)==null?void 0:i.default:r==null?void 0:r.default},"getEnumDefaultValue"),Ia=a((e,t)=>{let r=S.isString(t)&&Or(t);if(!r||!Ar(r.schema.type)||r.schema.type==="enum")return e;let n=e.default||r.schema.default;return{...e,default:n}},"resolveFieldDefaultValue"),ja=a(e=>Pr({...e,name:e.name||Cr(),fields:Object.keys(e.fields||{}).map(t=>Ba(t,e.fields[t]))}),"convertRecord"),Pr=a((e,t={})=>{let r=e.name,n=Or(r),i=n&&!n.isCollectionReference,o=Object.keys(t);return i&&la(e,n.schema)?sa(e):(n||aa({[r]:{schema:{...Br(e),...S.pick(e,o)},customProperties:mi(_i(e.type)),originalSchema:e,used:!0}}),{...S.omit(e,o),...o.reduce((s,u)=>({...s,[t[u]]:e[u]}),{})})},"convertNamedType"),Ma=a(e=>e,"convertPrimitive"),Fa=a(e=>Pr({...e,name:e.name||Cr()},{symbolDefault:"default"}),"convertEnum"),La=a(e=>({...e,type:e.mode||"int"}),"convertNumber"),qa=a(e=>S.uniqWith(e,(t,r)=>(t=hi(t),r=hi(r),Ar(t.type)&&Ar(r.type)?t.name===r.name:t.type===r.type)),"getUniqueItemsInArray"),hi=a(e=>S.isString(e)?{type:e}:e,"normalizeSchema"),Ha=a(e=>{let t=S.isArray(e.type)?S.first(e.type):e.type,r=S.isString(t)?t:t==null?void 0:t.type,n=S.isString(t)?e.default:t==null?void 0:t.default;return r==="null"&&n==="null"?null:r==="number"&&!isNaN(n)?Number(n):n},"getDefault"),Va=a(e=>e.reduce((t,r)=>{let n=S.get(da,r.metaKey,"metaValue");return{...t,[r.metaKey]:r[n]}},{}),"getMetaProperties");bi.exports=Le});var{setDependencies:Fr,dependencies:Lr}=ee(),{SCRIPT_TYPES:ne,SCHEMA_REGISTRIES_KEYS:Ir}=we(),{parseJson:qr,prepareName:Ei}=Ee(),Ua=qn(),{formatAvroSchemaByType:Da,getConfluentSubjectName:za}=hr(),{resolveUdt:$a,addDefinitions:jr,resetDefinitionsUsage:Ti,convertCollectionReferences:Ga,resolveNamespaceReferences:Ya,clearDefinitions:Ja}=gr(),Si=wi(),{initPluginConfiguration:Hr,getCustomProperties:ki,getEntityLevelConfig:Wa,getFieldLevelConfig:Ka}=kr(),ie,Za=a((e,t,r,n)=>{t.clear();try{Fr(n),Hr(e.pluginConfiguration,t),ie=Lr.lodash;let{containers:i,externalDefinitions:o,modelDefinitions:s,options:u}=e,c=e.modelData[0]||{},l=xi(e,c)||ne.CONFLUENT_SCHEMA_REGISTRY,p=Ri(u),d=Mr(o),h=Mr(s),y=(i||[]).flatMap(C=>C.entities.map(T=>tu(C,T))).map(C=>({...C,jsonSchema:qr(C.jsonSchema)})),_=Ci(y,u).map(C=>{try{let{containerData:T,entityData:oe,jsonSchema:ge,internalDefinitions:be,references:ft}=C;Ja(),jr(d),jr(h),Ft(be),Ti();let lt=Oi({containerData:T,entityData:oe,modelData:c,references:ft});return Ni({scriptType:l,needMinify:p,settings:lt,avroSchema:Ai(ge,lt.name)})}catch(T){return t.log("error",{message:T.message,stack:T.stack},"Avro Forward-Engineering Error"),""}}),m=su(e.containers),v=_.filter(Boolean).join(`

`);return Bi(e.options)?r(null,Pi(v,m)):r(null,v)}catch(i){t.log("error",{message:i.message,stack:i.stack},"Avro model Forward-Engineering Error"),r({message:i.message,stack:i.stack})}},"generateModelScript"),Qa=a((e,t,r,n)=>{var i;t.clear();try{Fr(n),Hr(e.pluginConfiguration,t),ie=Lr.lodash;let{containerData:o,entityData:s,modelData:u,jsonSchema:c,options:l,internalDefinitions:p,externalDefinitions:d,modelDefinitions:h}=e;Ft(d),Ft(h),Ft(p),Ti();let y=l.origin==="ui",{references:_,jsonSchema:m}=ie.first(Ci([{jsonSchema:qr(c)}],l))||{},v=Oi({containerData:o,entityData:s,modelData:u,references:_}),k=Ni({scriptType:eu(l,u),needMinify:Ri(l),isJsonFormat:!y,settings:v,avroSchema:Ai(m,v.name)});if(!Bi(l)){let C=(i=l==null?void 0:l.targetScriptOptions)==null?void 0:i.keyword,T=!y&&[ne.CONFLUENT_SCHEMA_REGISTRY,ne.AZURE_SCHEMA_REGISTRY,ne.PULSAR_SCHEMA_REGISTRY].includes(C);return C===ne.SCHEMA_REGISTRY||T?r(null,[{title:"Avro schemas",fileName:za(v),script:k}]):r(null,k)}return r(null,Pi(k,e.jsonData))}catch(o){t.log("error",{message:o.message,stack:o.stack},"Avro Forward-Engineering Error"),r({message:o.message,stack:o.stack})}},"generateScript"),Xa=a((e,t,r,n)=>{var c;Fr(n),Hr(e.pluginConfiguration),ie=Lr.lodash;let i=ie.isArray(e.script)?(c=ie.first(e.script))==null?void 0:c.script:e.script,o=e.modelData[0]||{},s=xi(e,o);!s&&i.startsWith("POST /")&&(s=ne.CONFLUENT_SCHEMA_REGISTRY);let u=Ua(i,s,t);return r(null,u)},"validate"),xi=a((e,t)=>{var r,n,i;return((r=e==null?void 0:e.targetScriptOptions)==null?void 0:r.keyword)===ne.SCHEMA_REGISTRY?ne[Ir[t==null?void 0:t.schemaRegistryType]]:((n=e==null?void 0:e.targetScriptOptions)==null?void 0:n.keyword)||((i=e==null?void 0:e.targetScriptOptions)==null?void 0:i.format)||ne[Ir[t==null?void 0:t.schemaRegistryType]]},"getScriptType"),eu=a((e,t)=>{var r,n;return((r=e==null?void 0:e.targetScriptOptions)==null?void 0:r.keyword)===ne.SCHEMA_REGISTRY?ne[Ir[t==null?void 0:t.schemaRegistryType]]:((n=e==null?void 0:e.targetScriptOptions)==null?void 0:n.keyword)||ne.COMMON},"getEntityScriptType"),tu=a((e,t)=>{let r=ie.first(ie.get(e,"containerData",[])),n=e.jsonSchema[t],i=e.jsonData[t],o=ie.first(e.entityData[t]),s=e.internalDefinitions[t];return{containerData:r,jsonSchema:n,jsonData:i,entityData:o,internalDefinitions:s}},"getEntityData"),Ai=a((e,t)=>{e={...e,name:t,type:"record"};let r=ki(Wa(),e),n=Si(e);if(Array.isArray(n))return n;let i={...!ie.isString(n)&&n,name:t,type:ie.isString(n)?n:"record",...r};return $a(iu(i))},"convertJsonToAvro"),Ft=a(e=>{jr(Mr(e))},"setUserDefinedTypes"),Mr=a(e=>(e=qr(e),Object.keys(e.properties||{}).map(r=>{let n=e.properties[r],i=ki(Ka(n.type),n);return{name:Ei(r),schema:Si(n),originalSchema:n,customProperties:i}}).reduce((r,{name:n,schema:i,customProperties:o,originalSchema:s})=>({...r,[n]:{schema:i,customProperties:o,originalSchema:s}}),{})),"convertSchemaToUserDefinedTypes"),Ni=a(({settings:e,scriptType:t,isJsonFormat:r,needMinify:n,avroSchema:i})=>Da({avroSchema:i,scriptType:t,isJsonFormat:r,needMinify:n,settings:e}),"getScript"),Oi=a(({containerData:e,entityData:t,modelData:r,references:n})=>({name:nu(t),namespace:(e==null?void 0:e.name)||"",topic:(t==null?void 0:t.pulsarTopicName)||"",persistence:t!=null&&t.isNonPersistentTopic?"non-persistent":"persistent",schemaGroupName:(e==null?void 0:e.schemaGroupName)||"",confluentSubjectName:(t==null?void 0:t.confluentSubjectName)||"",confluentCompatibility:(t==null?void 0:t.confluentCompatibility)||"",schemaType:(t==null?void 0:t.schemaType)||"",schemaTopic:(t==null?void 0:t.schemaTopic)||"",schemaNameStrategy:(t==null?void 0:t.schemaNameStrategy)||"",schemaRegistryType:(r==null?void 0:r.schemaRegistryType)||"",schemaRegistryUrl:(r==null?void 0:r.schemaRegistryUrl)||"",references:n||[]}),"getSettings"),Ci=a((e,t)=>ru(t)?Ya(e):Ga(e,t),"handleCollectionReferences"),Ri=a(e=>{var r;return(r=((e==null?void 0:e.additionalOptions)||[]).find(n=>n.id==="minify"))==null?void 0:r.value},"isMinifyNeeded"),ru=a(e=>{var r;return(r=((e==null?void 0:e.additionalOptions)||[]).find(n=>n.id==="resolveEntityReferences"))==null?void 0:r.value},"isResolveNamespaceReferenceNeeded"),nu=a(e=>Ei(e.code||e.name||e.collectionName),"getRootRecordName"),iu=a(e=>ou("fields")(e),"reorderAvroSchema"),ou=a(e=>t=>({...ie.omit(t,e),[e]:t[e]}),"setPropertyAsLast"),Bi=a((e={})=>{var t,r;return!((t=e==null?void 0:e.targetScriptOptions)!=null&&t.cliOnly)&&((r=(e.additionalOptions||[]).find(n=>n.id==="INCLUDE_SAMPLES"))==null?void 0:r.value)},"includeSamplesToScript"),Pi=a((e,t)=>[{title:"Avro schemas",script:e},{title:"Sample data",script:t}],"getScriptAndSampleResponse"),su=a(e=>{let t=e.flatMap(r=>Object.values(r.jsonData)).map(JSON.parse);return JSON.stringify(t,null,4)},"combineJsonData");module.exports={generateModelScript:Za,generateScript:Qa,validate:Xa};
